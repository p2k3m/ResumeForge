import { createRequire as __createRequire } from 'module';
import { fileURLToPath as __fileURLToPath } from 'url';
import path from 'path';
const require = __createRequire(import.meta.url);
const __filename = __fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
globalThis.__filename = globalThis.__filename || __filename;
globalThis.__dirname = globalThis.__dirname || __dirname;
import{GetObjectCommand as y,S3Client as C}from"@aws-sdk/client-s3";import{CloudWatchClient as h,PutMetricDataCommand as w}from"@aws-sdk/client-cloudwatch";import{gunzipSync as B}from"zlib";var F=new C({}),b=new h({});function s(t){return typeof t=="string"&&t.trim().length>0}async function k(t){if(!t)return Buffer.from([]);if(Buffer.isBuffer(t))return t;if(typeof t.transformToByteArray=="function"){let n=await t.transformToByteArray();return Buffer.from(n)}let o=[];for await(let n of t)o.push(Buffer.isBuffer(n)?n:Buffer.from(n));return Buffer.concat(o)}function S(t){if(!t||t.length===0)return"";try{return B(t).toString("utf-8")}catch{return t.toString("utf-8")}}function x(t){if(!s(t))return{entries:0,notFoundCount:0};let o=0,n=0;for(let e of t.split(/\r?\n/)){let r=e.trim();if(!r||r.startsWith("#"))continue;o+=1;let i=r.split("	");if(i.length>8){let c=Number.parseInt(i[8],10);Number.isInteger(c)&&c===404&&(n+=1)}}return{entries:o,notFoundCount:n}}function D(t){if(!s(t))return"";let o=/^E[A-Z0-9]{11,}$/,n=t.split("/");for(let e=n.length-1;e>=0;e-=1){let r=n[e];if(!s(r))continue;let i=r.split(".")[0];if(o.test(i))return i}return""}function N({distributionId:t,stageName:o,notFoundCount:n}){if(!s(t))throw new Error("Unable to determine CloudFront distribution identifier from log object key.");let e=[{Name:"DistributionId",Value:t}];return s(o)&&e.push({Name:"Stage",Value:o}),{MetricName:"Recurring404Count",Dimensions:e,Timestamp:new Date,Unit:"Count",Value:n}}async function A(t){let o=new w({Namespace:"ResumeForge/CloudFront",MetricData:[t]});await b.send(o)}async function a(t){if(!t?.Records||!Array.isArray(t.Records))return;let o=process.env.STAGE_NAME;for(let n of t.Records){let e=n?.s3?.bucket?.name,r=n?.s3?.object?.key;if(!s(e)||!s(r)){console.warn("Skipping S3 event without bucket/key.",{record:n});continue}let i=decodeURIComponent(r.replace(/\+/g," ")),c=D(i);if(!s(c)){console.warn("Skipping CloudFront log without a distribution identifier in the object key.",{bucket:e,key:r});continue}let f=new y({Bucket:e,Key:i}),m=await F.send(f),d=await k(m.Body),l=S(d),{notFoundCount:u,entries:p}=x(l);console.info("Processed CloudFront access log.",{bucket:e,key:r,entries:p,notFoundCount:u});let g=N({distributionId:c,stageName:o,notFoundCount:u});await A(g)}}export{a as default,a as handler};
