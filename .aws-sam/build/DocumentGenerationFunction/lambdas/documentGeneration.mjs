import { createRequire as __createRequire } from 'module';
import { fileURLToPath as __fileURLToPath } from 'url';
import path from 'path';
const require = __createRequire(import.meta.url);
const __filename = __fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
globalThis.__filename = globalThis.__filename || __filename;
globalThis.__dirname = globalThis.__dirname || __dirname;
var qe=Object.create;var ne=Object.defineProperty;var Fe=Object.getOwnPropertyDescriptor;var ke=Object.getOwnPropertyNames;var Ke=Object.getPrototypeOf,$e=Object.prototype.hasOwnProperty;var x=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var re=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var He=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of ke(t))!$e.call(e,o)&&o!==n&&ne(e,o,{get:()=>t[o],enumerable:!(r=Fe(t,o))||r.enumerable});return e};var We=(e,t,n)=>(n=e!=null?qe(Ke(e)):{},He(t||!e||!e.__esModule?ne(n,"default",{value:e,enumerable:!0}):n,e));var oe=re((jn,Ge)=>{Ge.exports={name:"dotenv",version:"16.6.1",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=text --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},homepage:"https://github.com/motdotla/dotenv#readme",funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var ce=re((xn,A)=>{var $=x("fs"),P=x("path"),Ye=x("os"),ze=x("crypto"),Qe=oe(),H=Qe.version,Je=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function Xe(e){let t={},n=e.toString();n=n.replace(/\r\n?/mg,`
`);let r;for(;(r=Je.exec(n))!=null;){let o=r[1],s=r[2]||"";s=s.trim();let i=s[0];s=s.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),i==='"'&&(s=s.replace(/\\n/g,`
`),s=s.replace(/\\r/g,"\r")),t[o]=s}return t}function Ze(e){e=e||{};let t=ue(e);e.path=t;let n=g.configDotenv(e);if(!n.parsed){let i=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw i.code="MISSING_DATA",i}let r=ae(e).split(","),o=r.length,s;for(let i=0;i<o;i++)try{let a=r[i].trim(),c=tt(n,a);s=g.decrypt(c.ciphertext,c.key);break}catch(a){if(i+1>=o)throw a}return g.parse(s)}function et(e){console.log(`[dotenv@${H}][WARN] ${e}`)}function M(e){console.log(`[dotenv@${H}][DEBUG] ${e}`)}function ie(e){console.log(`[dotenv@${H}] ${e}`)}function ae(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function tt(e,t){let n;try{n=new URL(t)}catch(a){if(a.code==="ERR_INVALID_URL"){let c=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw c.code="INVALID_DOTENV_KEY",c}throw a}let r=n.password;if(!r){let a=new Error("INVALID_DOTENV_KEY: Missing key part");throw a.code="INVALID_DOTENV_KEY",a}let o=n.searchParams.get("environment");if(!o){let a=new Error("INVALID_DOTENV_KEY: Missing environment part");throw a.code="INVALID_DOTENV_KEY",a}let s=`DOTENV_VAULT_${o.toUpperCase()}`,i=e.parsed[s];if(!i){let a=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${s} in your .env.vault file.`);throw a.code="NOT_FOUND_DOTENV_ENVIRONMENT",a}return{ciphertext:i,key:r}}function ue(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let n of e.path)$.existsSync(n)&&(t=n.endsWith(".vault")?n:`${n}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=P.resolve(process.cwd(),".env.vault");return $.existsSync(t)?t:null}function se(e){return e[0]==="~"?P.join(Ye.homedir(),e.slice(1)):e}function nt(e){let t=!!(e&&e.debug),n=e&&"quiet"in e?e.quiet:!0;(t||!n)&&ie("Loading env from encrypted .env.vault");let r=g._parseVault(e),o=process.env;return e&&e.processEnv!=null&&(o=e.processEnv),g.populate(o,r,e),{parsed:r}}function rt(e){let t=P.resolve(process.cwd(),".env"),n="utf8",r=!!(e&&e.debug),o=e&&"quiet"in e?e.quiet:!0;e&&e.encoding?n=e.encoding:r&&M("No encoding is specified. UTF-8 is used by default");let s=[t];if(e&&e.path)if(!Array.isArray(e.path))s=[se(e.path)];else{s=[];for(let f of e.path)s.push(se(f))}let i,a={};for(let f of s)try{let u=g.parse($.readFileSync(f,{encoding:n}));g.populate(a,u,e)}catch(u){r&&M(`Failed to load ${f} ${u.message}`),i=u}let c=process.env;if(e&&e.processEnv!=null&&(c=e.processEnv),g.populate(c,a,e),r||!o){let f=Object.keys(a).length,u=[];for(let d of s)try{let l=P.relative(process.cwd(),d);u.push(l)}catch(l){r&&M(`Failed to load ${d} ${l.message}`),i=l}ie(`injecting env (${f}) from ${u.join(",")}`)}return i?{parsed:a,error:i}:{parsed:a}}function ot(e){if(ae(e).length===0)return g.configDotenv(e);let t=ue(e);return t?g._configVault(e):(et(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),g.configDotenv(e))}function st(e,t){let n=Buffer.from(t.slice(-64),"hex"),r=Buffer.from(e,"base64"),o=r.subarray(0,12),s=r.subarray(-16);r=r.subarray(12,-16);try{let i=ze.createDecipheriv("aes-256-gcm",n,o);return i.setAuthTag(s),`${i.update(r)}${i.final()}`}catch(i){let a=i instanceof RangeError,c=i.message==="Invalid key length",f=i.message==="Unsupported state or unable to authenticate data";if(a||c){let u=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw u.code="INVALID_DOTENV_KEY",u}else if(f){let u=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw u.code="DECRYPTION_FAILED",u}else throw i}}function it(e,t,n={}){let r=!!(n&&n.debug),o=!!(n&&n.override);if(typeof t!="object"){let s=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw s.code="OBJECT_REQUIRED",s}for(let s of Object.keys(t))Object.prototype.hasOwnProperty.call(e,s)?(o===!0&&(e[s]=t[s]),r&&M(o===!0?`"${s}" is already defined and WAS overwritten`:`"${s}" is already defined and was NOT overwritten`)):e[s]=t[s]}var g={configDotenv:rt,_configVault:nt,_parseVault:Ze,config:ot,decrypt:st,parse:Xe,populate:it};A.exports.configDotenv=g.configDotenv;A.exports._configVault=g._configVault;A.exports._parseVault=g._parseVault;A.exports.config=g.config;A.exports.decrypt=g.decrypt;A.exports.parse=g.parse;A.exports.populate=g.populate;A.exports=g});import{LambdaClient as yn,InvokeCommand as En}from"@aws-sdk/client-lambda";import{SQSClient as hn,SendMessageCommand as bn}from"@aws-sdk/client-sqs";import{createHash as Nn,randomUUID as Tn}from"crypto";var pe=We(ce(),1);import dt from"fs";import lt from"path";import S from"process";import N from"node:process";function b(e){return typeof e=="string"&&e.trim().length>0}function C(e){return typeof e=="string"?e.trim():""}var fe=new Map(Object.entries({development:"dev",dev:"dev",production:"prod",prod:"prod",staging:"stage",stage:"stage",testing:"test",test:"test"}));function v(e){let t=C(e).toLowerCase();return t?fe.has(t)?fe.get(t):t:""}function at(){let e=C(N.env.NODE_ENV);return v(e)}function de(){if(b(N.env.STAGE_NAME)){let t=v(N.env.STAGE_NAME);if(t)return t}if(b(N.env.DEPLOYMENT_ENVIRONMENT)){let t=v(N.env.DEPLOYMENT_ENVIRONMENT);if(t)return t}let e=at();return e||"dev"}function ut({stageName:e}={}){if(b(N.env.DEPLOYMENT_ENVIRONMENT)){let n=v(N.env.DEPLOYMENT_ENVIRONMENT);if(n)return n}let t=b(e)?v(e):de();return t||"dev"}function le(){return b(N.env.DATA_BUCKET)?C(N.env.DATA_BUCKET):b(N.env.S3_BUCKET)?C(N.env.S3_BUCKET):""}function ct({dataBucket:e}={}){if(b(N.env.STATIC_ASSETS_BUCKET))return C(N.env.STATIC_ASSETS_BUCKET);if(b(e))return C(e);let t=le();return t||""}function ft(){return b(N.env.LOGS_BUCKET)?C(N.env.LOGS_BUCKET):""}function I(e,t){typeof e=="string"&&b(t)&&(N.env[e]=C(t))}function me({propagateToProcessEnv:e=!0,propagateViteEnv:t=!1}={}){let n=de(),r=ut({stageName:n}),o=le(),s=ct({dataBucket:o}),i=ft();return e&&(I("STAGE_NAME",n),I("DEPLOYMENT_ENVIRONMENT",r),b(o)&&I("S3_BUCKET",o),b(s)&&I("STATIC_ASSETS_BUCKET",s),b(i)&&I("LOGS_BUCKET",i)),t&&(I("VITE_STAGE_NAME",n),I("VITE_DEPLOYMENT_ENVIRONMENT",r),b(o)&&(I("VITE_S3_BUCKET",o),I("VITE_DATA_BUCKET",o)),b(s)&&I("VITE_STATIC_ASSETS_BUCKET",s),b(i)&&I("VITE_LOGS_BUCKET",i)),{stageName:n,deploymentEnvironment:r,dataBucket:o,staticAssetsBucket:s,logsBucket:i}}function O(e){return typeof e=="string"&&e.trim().length>0}var mt=O(S.env.NODE_ENV)?S.env.NODE_ENV.trim().toLowerCase():"development",pt=!!S.env.AWS_LAMBDA_FUNCTION_NAME,gt=!pt&&(mt==="development"||!O(S.env.NODE_ENV));if(gt){let e=lt.resolve(S.cwd(),".env");dt.existsSync(e)&&pe.default.config({path:e})}var ge=["S3_BUCKET","GEMINI_API_KEY"],yt=["CLOUDFRONT_ORIGINS"],W=ge.filter(e=>!O(S.env[e]));yt.forEach(e=>{O(S.env[e])||console.warn(`Optional environment value ${e} is not set. Provide it via the runtime config file or environment to enable strict CORS.`)});!O(S.env.AWS_REGION)&&O(S.env.AWS_DEFAULT_REGION)&&(S.env.AWS_REGION=S.env.AWS_DEFAULT_REGION.trim());O(S.env.AWS_REGION)||W.push("AWS_REGION");if(W.length>0)throw new Error(`Missing required environment variables: ${W.join(", ")}. Ensure they are configured via deployment secrets or a local .env file.`);var{stageName:Kn,deploymentEnvironment:Et}=me({propagateToProcessEnv:!0,propagateViteEnv:!1});function ht(e){let t=new URLSearchParams(e||"");return t.set("environment",Et),t.toString()}function L(e={}){return{...e,Tagging:ht(e.Tagging)}}var $n=Object.freeze([...ge,"AWS_REGION"]);import{CloudWatchClient as Pt,PutMetricDataCommand as J}from"@aws-sdk/client-cloudwatch";import{S3Client as Ut}from"@aws-sdk/client-s3";import{randomUUID as ve}from"crypto";import{GetObjectCommand as Lt,PutObjectCommand as _e}from"@aws-sdk/client-s3";var ye=new Set(["ECONNRESET","ECONNREFUSED","ETIMEDOUT","EPIPE","EAI_AGAIN","ENOTFOUND","ECONNABORTED","ENETUNREACH","EHOSTUNREACH"]),Ee=new Set(["SLOWDOWN","SLOWDOWNERROR","REQUESTTIMEOUT","THROTTLING","THROTTLINGEXCEPTION","SERVICEUNAVAILABLE","INTERNALERROR"]);function bt(e){return new Promise(t=>setTimeout(t,e))}function U(e){if(!(!e||typeof e!="object")){if(typeof e.status=="number")return e.status;if(typeof e.statusCode=="number")return e.statusCode;if(typeof e.$metadata?.httpStatusCode=="number")return e.$metadata.httpStatusCode;if(typeof e.response?.status=="number")return e.response.status;if(typeof e.cause?.status=="number")return e.cause.status;if(typeof e.cause?.statusCode=="number")return e.cause.statusCode}}function Nt(e){return Number.isFinite(e)?e===429||e>=500:!1}function Tt(e){if(!e||typeof e!="object")return!1;let t=typeof e.code=="string"?e.code.toUpperCase():"";if(t&&ye.has(t))return!0;let n=typeof e.name=="string"?e.name.toUpperCase():"";if(n&&ye.has(n))return!0;let r=typeof e.message=="string"?e.message.toLowerCase():"";return r?r.includes("timed out")||r.includes("timeout")||r.includes("temporarily unavailable")||r.includes("connection reset")||r.includes("socket hang up"):!1}function G(e){if(!e||typeof e!="object")return!1;let t=U(e);if(Nt(t)||Tt(e))return!0;let n=typeof e.code=="string"?e.code.toUpperCase():"";if(n&&Ee.has(n))return!0;let r=typeof e.name=="string"?e.name.toUpperCase():"";return!!(r&&Ee.has(r))}async function Y(e,t={}){let{maxAttempts:n=3,baseDelayMs:r=500,maxDelayMs:o=5e3,jitterMs:s=250,shouldRetry:i=()=>!1,onRetry:a}=t,c;for(let f=1;f<=n;f+=1)try{return await e(f)}catch(u){if(c=u,!(f<n&&i(u,f)))throw u;let l=r*2**(f-1),m=Math.min(o,l),E=s>0?Math.floor(Math.random()*s):0,y=Math.max(0,m+E);if(typeof a=="function")try{a(u,f,y)}catch{}await bt(y)}throw c}import{randomBytes as Vt,randomUUID as Te}from"crypto";import w from"node:process";var B=null;function he(e=[]){for(let t of e)if(typeof t=="string"){let n=t.trim();if(n)return n}return null}function St(e){if(!e)return null;let t=new Date(e);return Number.isNaN(t.getTime())?null:t.toISOString()}function It(){let e=[w.env.BUILD_TIMESTAMP,w.env.DEPLOY_TIMESTAMP];for(let t of e){let n=St(t);if(n)return n}return new Date().toISOString()}function _t(){if(B)return B;let e=he([w.env.BUILD_VERSION,w.env.VERSION,w.env.npm_package_version]),t=he([w.env.BUILD_SHA,w.env.GIT_COMMIT,w.env.GIT_SHA,w.env.GITHUB_SHA]),n=It();return B={version:e||null,sha:t||null,timestamp:n},B}function z(e,{fallback:t="unknown"}={}){return typeof e=="string"&&e.trim()?e.trim():typeof e=="number"&&Number.isFinite(e)?String(e):t}function be({versionLabel:e}={}){let{version:t,sha:n,timestamp:r}=_t(),o={"build-timestamp":z(r,{fallback:new Date().toISOString()}),"build-version":z(t||e),"build-sha":z(n)};return typeof e=="string"&&e.trim()&&(o["asset-version-label"]=e.trim()),o}function At(e={}){let t=be(e),n=typeof t["build-sha"]=="string"?t["build-sha"].trim():"",r=typeof t["build-timestamp"]=="string"?t["build-timestamp"].trim():"",o=[];return n&&o.push({Key:"build",Value:n}),r&&o.push({Key:"deployed",Value:r}),o}function wt(e,t=[]){let n=new URLSearchParams(e||"");for(let r of t){if(!r||typeof r.Key!="string")continue;let o=r.Key.trim();if(!o)continue;let s=typeof r.Value=="string"?r.Value.trim():"";s&&n.set(o,s)}return n.toString()}function Q(e={},t={}){let n=be(t),r=e&&typeof e=="object"&&typeof e.Metadata=="object"&&e.Metadata!==null&&!Array.isArray(e.Metadata)?e.Metadata:{},o=wt(e?.Tagging,At(t)),s={...e,Metadata:{...r,...n}};return o&&(s.Tagging=o),s}function _(e){return e==null?"":typeof e=="string"?e.trim():typeof e=="number"||typeof e=="bigint"?String(e):""}function V(...e){for(let t of e){let n=_(t);if(n)return n}return""}function Ct(){return V(process.env.RESUMEFORGE_BUILD_ID,process.env.BUILD_ID,process.env.DEPLOYMENT_BUILD_ID,process.env.GITHUB_RUN_ID,process.env.GITHUB_SHA,process.env.AWS_LAMBDA_FUNCTION_VERSION)||"local-dev"}var Ot=Ct();function Rt(e={}){return V(e.build,e.buildId,e.metadata?.build,e.metadata?.buildId)||Ot}function Dt(e={}){let t=n=>Array.isArray(n)&&n.length?n[0]:"";return V(e.template,e.templateId,e.resumeTemplate,e.coverTemplate,e.preferredTemplate,e.canonicalSelectedTemplate,e.selectedTemplate,e.template1,e.template2,t(e.templates),t(e.availableCvTemplates),e.coverTemplate1,e.coverTemplate2)||"unknown"}function Mt(e={}){return V(e.session,e.sessionId,e.jobId,e.requestId,e.detail?.sessionId,e.detail?.jobId,e.metadata?.session,e.metadata?.sessionId)||"unknown"}function vt(e={}){let t=Array.isArray(e.urls)?e.urls:[],n=t.length>0?_(t[0]?.type):"",r=()=>{let o=_(e.event);return o?o.includes("cover_letter")?"cover_letter":o.includes("generation_artifacts")?"generated_artifact":o.includes("initial_upload")?"upload_artifact":"":""};return V(e.artifactType,e.metadata?.artifactType,e.type,e.cleanupEvent,n,r())||"none"}function q(e={},t={},n={}){let{embedMetadata:r=!0}=n;if(!e||typeof e!="object")return e;let o={...typeof e.metadata=="object"&&e.metadata?e.metadata:{},...typeof t.metadata=="object"&&t.metadata?t.metadata:{}},s={...o,...e,...t},i=Dt(s),a=Mt(s),c=Rt({...s,metadata:o}),f=vt(s),u={...e};_(u.template)||(u.template=i),_(u.session)||(u.session=a),_(u.build)||(u.build=c),_(u.artifactType)||(u.artifactType=f);let d={...o};return _(d.template)||(d.template=i),_(d.session)||(d.session=a),_(d.build)||(d.build=c),_(d.artifactType)||(d.artifactType=f),r?(Object.keys(d).length>0&&(u.metadata=d),u):d}function Ne(e={},t={}){let n=q(e,t,{embedMetadata:!1});return!n||typeof n!="object"?{}:n}async function jt(e){return await new Promise((t,n)=>{let r=[];e.on("data",o=>r.push(o)),e.on("error",n),e.on("end",()=>t(Buffer.concat(r).toString("utf-8")))})}async function Ae({s3:e,bucket:t,key:n,jobId:r,event:o,level:s="info",message:i,metadata:a,template:c,session:f,build:u,artifactType:d}){let l={jobId:r,template:c,session:f,build:u,artifactType:d},m=a&&typeof a=="object"&&!Array.isArray(a)?a:{},E=Ne(m,l),y=q({timestamp:new Date().toISOString(),jobId:r,event:o,level:s,...i?{message:i}:{},metadata:E},l),T="";try{let h=await e.send(new Lt({Bucket:t,Key:n}));T=await jt(h.Body)}catch(h){if(h.name!=="NoSuchKey"&&h.$metadata?.httpStatusCode!==404)throw h}let p=T+JSON.stringify(y)+`
`;await Y(()=>e.send(new _e(L(Q({Bucket:t,Key:n,Body:p,ContentType:"application/json"})))),{maxAttempts:4,baseDelayMs:500,maxDelayMs:4e3,jitterMs:300,shouldRetry:h=>G(h),onRetry:(h,Ue,Be)=>{console.warn("Retrying S3 log upload",{bucket:t,key:n,attempt:Ue,delayMs:Be,status:U(h),code:h?.code})}})}function Se(){if(typeof Te=="function")try{return Te()}catch{}return Vt(16).toString("hex")}function Ie(e){return e?String(e).trim().replace(/[^a-zA-Z0-9._-]+/g,"-").replace(/^-+|-+$/g,"").slice(0,80):""}function xt(e=""){if(!e)return"";let t=e.replace(/^\/+/,"").replace(/\/+/g,"/");return t.endsWith("/")?t:`${t}/`}async function we({s3:e,bucket:t,entry:n,prefix:r="logs/errors/",key:o}){if(!e||!t||!n)return;let s=typeof n?.timestamp=="string"&&n.timestamp.trim()?n.timestamp:new Date().toISOString(),i=s.slice(0,10),a=Ie(n.requestId)||Se(),c=Ie(s)||Se(),f=xt(r),u=typeof o=="string"&&o.trim()?o.trim():`${f}${i}/${c}-${a}.json`,d=q({...n,timestamp:s},{jobId:n?.jobId,template:n?.template,session:n?.session,build:n?.build,artifactType:n?.artifactType,metadata:n?.metadata});await Y(()=>e.send(new _e(L(Q({Bucket:t,Key:u,Body:JSON.stringify(d),ContentType:"application/json"})))),{maxAttempts:4,baseDelayMs:500,maxDelayMs:4e3,jitterMs:300,shouldRetry:l=>G(l),onRetry:(l,m,E)=>{console.warn("Retrying S3 trace upload",{bucket:t,key:o,attempt:m,delayMs:E,status:U(l),code:l?.code})}})}var j=process.env.AWS_REGION||process.env.AWS_DEFAULT_REGION||void 0,F=j?new Pt({region:j}):null,K=j?new Ut({region:j}):null,Ce=process.env.METRICS_NAMESPACE||"ResumeForge/Operations",Bt=process.env.ARTIFACT_METRICS_NAMESPACE||"ResumeForge/Artifacts",X=process.env.SESSION_CHANGE_LOG_PREFIX||"logs/sessions/",qt=process.env.LAMBDA_ERROR_TRACE_PREFIX||"logs/errors/",Ft=process.env.ARTIFACT_FAILURE_LOG_PREFIX||"logs/artifact-failures/",D=process.env.LOGS_BUCKET||process.env.S3_BUCKET||"",R=process.env.STAGE_NAME||process.env.DEPLOYMENT_ENVIRONMENT||"prod",kt=/^\/(?:assets|fonts|images|cover-templates)(?:\b|\/)/i,Oe=Object.freeze({"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token","Access-Control-Allow-Methods":"OPTIONS,GET,POST"}),Kt="An unexpected error occurred. Please try again later.",$t="The request could not be completed.";function Ht(e={},t={}){return e?.requestContext?.requestId||e?.headers?.["x-amzn-requestid"]||e?.headers?.["x-amzn-request-id"]||t?.awsRequestId||ve()}function Wt(e={}){if(!e||typeof e!="object")return"";if(typeof e.sessionId=="string"&&e.sessionId.trim())return e.sessionId.trim();if(typeof e.jobId=="string"&&e.jobId.trim())return e.jobId.trim();if(typeof e.detail=="object"&&e.detail){let t=e.detail;if(typeof t.sessionId=="string"&&t.sessionId.trim())return t.sessionId.trim();if(typeof t.jobId=="string"&&t.jobId.trim())return t.jobId.trim()}if(Array.isArray(e.Records)&&e.Records.length>0){let t=e.Records[0];if(t&&typeof t.body=="string")try{let n=JSON.parse(t.body);if(n&&typeof n=="object"){if(typeof n.sessionId=="string"&&n.sessionId.trim())return n.sessionId.trim();if(typeof n.jobId=="string"&&n.jobId.trim())return n.jobId.trim();if(n.payload&&typeof n.payload=="object"&&typeof n.payload.jobId=="string"&&n.payload.jobId.trim())return n.payload.jobId.trim()}}catch{}}return""}function Gt(e=""){return String(e).trim().replace(/[^a-zA-Z0-9._-]+/g,"-").replace(/^-+|-+$/g,"").slice(0,120)}function Yt(e,t){let n=e||t;if(!n)return"";let r=Gt(n);return`${X.endsWith("/")?X:`${X}/`}${r}.jsonl`}function zt(e={}){return e?.requestContext?.http?{type:"http",method:e.requestContext.http.method,path:e.requestContext.http.path,protocol:e.requestContext.http.protocol,sourceIp:e.requestContext.http.sourceIp,userAgent:e.requestContext.http.userAgent}:typeof e.httpMethod=="string"&&typeof e.path=="string"?{type:"http-legacy",method:e.httpMethod,path:e.path}:Array.isArray(e.Records)?{type:"records",recordCount:e.Records.length,sources:Array.from(new Set(e.Records.map(t=>t.eventSource||t.EventSource||t.source).filter(Boolean)))}:e?.detailType||e?.source?{type:"event-bridge",detailType:e.detailType,source:e.source}:e?.source==="aws.states"?{type:"step-functions"}:{type:typeof e}}function Qt(e){if(!e||typeof e!="object")return{};let t={};for(let[n,r]of Object.entries(e))typeof n=="string"&&(t[n.toLowerCase()]=r);return t}function Re(e){if(typeof e!="string")return null;let t=e.trim();if(!t||!t.startsWith("{")&&!t.startsWith("["))return null;try{return JSON.parse(t)}catch{return null}}function Jt(e){return e&&Array.isArray(e)?e.filter(t=>t!=null).length:0}function Xt(e){if(!e||typeof e!="object")return 0;let t=[e.sessionCount,e.totalSessions,e.sessions?.length,e.sessionLogs?.length].filter(r=>Number.isFinite(r)&&r>0),n=t.length?Math.max(...t.map(r=>Number(r))):0;return typeof e.sessionId=="string"&&e.sessionId.trim()&&(n=Math.max(n,1)),Array.isArray(e.sessionIds)&&(n=Math.max(n,e.sessionIds.length)),Array.isArray(e.sessions)&&(n=Math.max(n,e.sessions.length)),Array.isArray(e.sessionLogs)&&(n=Math.max(n,e.sessionLogs.length)),n}var Zt=["urls","downloads","downloadUrls","download_logs","downloadLogs","files","artifacts","links"],en=["downloadCount","totalDownloads","downloadTotal"];function tn(e){if(!e||typeof e!="object")return 0;let t=0;for(let n of en){let r=e[n];Number.isFinite(r)&&r>0&&(t=Math.max(t,Number(r)))}for(let n of Zt)Array.isArray(e[n])&&(t=Math.max(t,Jt(e[n])));return t}function nn(e={},t={}){return typeof t?.path=="string"&&t.path?t.path:typeof e?.rawPath=="string"&&e.rawPath?e.rawPath:typeof e?.path=="string"&&e.path?e.path:typeof e?.requestContext?.http?.path=="string"?e.requestContext.http.path:""}function rn(e={},t={}){return typeof t?.method=="string"&&t.method?t.method:typeof e?.requestContext?.http?.method=="string"?e.requestContext.http.method:typeof e?.httpMethod=="string"?e.httpMethod:""}function on(e=""){if(typeof e!="string"||!e)return"unknown";if(e==="/"||e==="")return"root";if(e.startsWith("/api/")){let[,,t]=e.split("/",3);return t?`/api/${t}`:"/api"}return e.startsWith("/assets")?"/assets":e.startsWith("/fonts")?"/fonts":e.startsWith("/images")?"/images":e.startsWith("/cover-templates")?"/cover-templates":e.split("?")[0]||"unknown"}function sn(e,{event:t,requestMetadata:n,durationMs:r}={}){if(!e||typeof e!="object")return null;let o=Qt(e.headers),s=Number.isInteger(e.statusCode)?Number(e.statusCode):void 0,i=rn(t,n),a=nn(t,n),c=o["content-length"],f=c!==void 0?Number(c):!e.isBase64Encoded&&typeof e.body=="string"?Buffer.byteLength(e.body):void 0,u=null,d=o["content-type"],l=typeof d=="string"&&/json/i.test(d);!e.isBase64Encoded&&typeof e.body=="string"&&e.body&&(u=Re(e.body));let m=Xt(u),E=tn(u),y=on(a),T=kt.test(a);return{statusCode:s,method:i,path:a,pathCategory:y,contentLength:Number.isFinite(f)?f:void 0,sessionCount:Number.isFinite(m)&&m>0?m:0,downloadCount:Number.isFinite(E)&&E>0?E:0,isAssetRequest:T,durationMs:Number.isFinite(r)?r:void 0}}function an(e={}){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([,t])=>t!=null))}function De(e={}){return!e||typeof e!="object"?!1:!!(typeof e.httpMethod=="string"||e?.requestContext?.http&&typeof e.requestContext.http.method=="string"||typeof e.version=="string"&&e.version.startsWith("2")&&(typeof e.rawPath=="string"||typeof e.routeKey=="string")||typeof e.rawPath=="string"&&typeof e.requestContext=="object"||typeof e.resource=="string"&&typeof e.path=="string")}function un(e){return[e?.statusCode,e?.status,e?.httpStatus,e?.response?.status,e?.output?.statusCode].find(r=>Number.isInteger(r)&&r>=400&&r<=599)??500}function cn(e,t){return typeof e?.code=="string"&&e.code.trim()?e.code.trim():t>=500?"INTERNAL_SERVER_ERROR":"BAD_REQUEST"}function fn(e,t){return typeof e?.message=="string"&&e.message.trim()?e.message.trim():t>=500?Kt:$t}function dn(e){if(e?.details!==void 0)return e.details;if(e?.errors!==void 0)return e.errors;if(e?.data!==void 0)return e.data;if(e?.response?.data!==void 0)return e.response.data}function ln(e){return!e||typeof e!="object"?{...Oe}:{...Oe,...e}}function mn(e,{requestId:t}={}){let n=un(e),r=cn(e,n),o=fn(e,n),s=dn(e),i={success:!1,code:r,message:o,...s!==void 0?{details:s}:{},...t?{requestId:t}:{}},a;if(typeof e?.body=="string")a=e.body;else if(e?.body&&typeof e.body=="object")try{a=JSON.stringify(e.body)}catch{a=JSON.stringify(i)}else a=JSON.stringify(i);return{statusCode:n,headers:ln(e?.headers),body:a,isBase64Encoded:!!(e?.isBase64Encoded&&a===e?.body)}}function pn(e,t,n){if(!e)return[];let r=(s={})=>{let i=t.map(a=>({...a}));e.pathCategory&&i.push({Name:"Path",Value:e.pathCategory}),e.method&&i.push({Name:"Method",Value:e.method}),e.isAssetRequest&&i.push({Name:"AssetRequest",Value:"true"});for(let[a,c]of Object.entries(s))typeof a=="string"&&typeof c=="string"&&i.push({Name:a,Value:c});return i},o=[];return e.isAssetRequest&&Number.isFinite(e.durationMs)&&o.push({MetricName:"AssetResponseDuration",Dimensions:r(),Timestamp:n,Unit:"Milliseconds",Value:e.durationMs}),e.statusCode===404&&o.push({MetricName:"HttpNotFound",Dimensions:r(),Timestamp:n,Unit:"Count",Value:1}),Number.isFinite(e.sessionCount)&&e.sessionCount>0&&o.push({MetricName:"SessionCount",Dimensions:r({Detail:"Sessions"}),Timestamp:n,Unit:"Count",Value:e.sessionCount}),Number.isFinite(e.downloadCount)&&e.downloadCount>0&&o.push({MetricName:"DownloadCount",Dimensions:r({Detail:"Downloads"}),Timestamp:n,Unit:"Count",Value:e.downloadCount}),o}async function Me({functionName:e,durationMs:t,success:n,coldStart:r,operationGroup:o,httpSummary:s}){if(!F||!j)return;let i=new Date,a=[{Name:"FunctionName",Value:e},{Name:"Stage",Value:R}];o&&a.push({Name:"Operation",Value:o});let c=[{MetricName:"InvocationDuration",Dimensions:a,Timestamp:i,Unit:"Milliseconds",Value:t},{MetricName:"InvocationCount",Dimensions:[...a,{Name:"Status",Value:n?"Success":"Failure"}],Timestamp:i,Unit:"Count",Value:1}];r&&c.push({MetricName:"ColdStart",Dimensions:a,Timestamp:i,Unit:"Count",Value:1});try{await F.send(new J({Namespace:Ce,MetricData:c}))}catch(l){console.warn("Failed to publish lambda metrics",{functionName:e,stage:R,errorMessage:l?.message})}let f=pn(s,a,i);if(f.length)try{await F.send(new J({Namespace:Ce,MetricData:f}))}catch(l){console.warn("Failed to publish HTTP summary metrics",{functionName:e,stage:R,errorMessage:l?.message})}if(!o)return;let u=n?"Success":"Failure",d=[{MetricName:`${o.replace(/-/g," ").replace(/\s+/g,"")}${u}`,Dimensions:[{Name:"Operation",Value:o},{Name:"Stage",Value:R}],Timestamp:i,Unit:"Count",Value:1}];try{await F.send(new J({Namespace:Bt,MetricData:d}))}catch(l){console.warn("Failed to publish artifact metrics",{operationGroup:o,stage:R,errorMessage:l?.message})}}async function k({sessionId:e,requestId:t,jobId:n,event:r,metadata:o}){if(!K||!D)return;let s=Yt(e,t);if(s)try{await Ae({s3:K,bucket:D,key:s,jobId:n||e||t,event:r,metadata:L({...o,stage:R})})}catch(i){console.warn("Failed to append session change log",{key:s,bucket:D,event:r,errorMessage:i?.message})}}async function gn({error:e,requestId:t,sessionId:n,jobId:r,functionName:o,operationGroup:s,metadata:i,prefix:a}){if(!K||!D||!e)return;let c={requestId:t,sessionId:n,jobId:r,functionName:o,operationGroup:s,message:e.message,stack:e.stack,metadata:i};try{await we({s3:K,bucket:D,entry:c,prefix:a})}catch(f){console.warn("Failed to upload lambda error trace",{functionName:o,bucket:D,errorMessage:f?.message})}}function Le(e,{name:t="lambda-function",operationGroup:n,captureErrorTrace:r=!1}={}){if(typeof e!="function")throw new TypeError("withLambdaObservability expects a handler function.");let o=!0;return async function(i,a){let c=a?.functionName||t,f=Ht(i,a),u=Wt(i),d=typeof i?.jobId=="string"?i.jobId:"",l=ve(),m=zt(i);console.info("Lambda invocation started",{invocationId:l,functionName:c,requestId:f,sessionId:u,jobId:d,coldStart:o,operationGroup:n,requestMetadata:m}),await k({sessionId:u,requestId:f,jobId:d,event:"lambda_invocation_started",metadata:{invocationId:l,functionName:c,operationGroup:n,coldStart:o,requestMetadata:m}});let E=Date.now();try{let y=await e(i,a),T=Date.now()-E;console.info("Lambda invocation completed",{invocationId:l,functionName:c,requestId:f,sessionId:u,jobId:d,durationMs:T,operationGroup:n,coldStart:o});let p=De(i)?sn(y,{event:i,requestMetadata:m,durationMs:T}):null;if(p){let h=an({invocationId:l,functionName:c,requestId:f,sessionId:u,jobId:d,operationGroup:n,durationMs:T,method:p.method,path:p.path,pathCategory:p.pathCategory,statusCode:p.statusCode,contentLength:p.contentLength,sessionCount:p.sessionCount,downloadCount:p.downloadCount,assetRequest:p.isAssetRequest||void 0});console.info("API gateway response summary",h),p.isAssetRequest&&console.info("API gateway asset response",h),p.statusCode===404&&console.warn("API gateway not found response",h),(Number.isFinite(p.sessionCount)&&p.sessionCount>0||Number.isFinite(p.downloadCount)&&p.downloadCount>0)&&console.info("API gateway session download totals",{...h,sessionCount:p.sessionCount,downloadCount:p.downloadCount}),await k({sessionId:u,requestId:f,jobId:d,event:"lambda_http_response_summary",metadata:{...h,requestMetadata:m}})}return await k({sessionId:u,requestId:f,jobId:d,event:"lambda_invocation_succeeded",metadata:{invocationId:l,functionName:c,operationGroup:n,durationMs:T,coldStart:o}}),await Me({functionName:c,durationMs:T,success:!0,coldStart:o,operationGroup:n,httpSummary:p}),o=!1,y}catch(y){let T=Date.now()-E;if(console.error("Lambda invocation failed",{invocationId:l,functionName:c,requestId:f,sessionId:u,jobId:d,durationMs:T,operationGroup:n,coldStart:o,errorMessage:y?.message,errorCode:y?.code}),await k({sessionId:u,requestId:f,jobId:d,event:"lambda_invocation_failed",metadata:{invocationId:l,functionName:c,operationGroup:n,durationMs:T,coldStart:o,errorMessage:y?.message,errorCode:y?.code}}),await Me({functionName:c,durationMs:T,success:!1,coldStart:o,operationGroup:n,httpSummary:void 0}),(r||n&&["artifact-generation","artifact-download","enhancement"].includes(n))&&await gn({error:y,requestId:f,sessionId:u,jobId:d,functionName:c,operationGroup:n,metadata:{invocationId:l,durationMs:T,requestMetadata:m},prefix:n==="artifact-generation"||n==="artifact-download"||n==="enhancement"?Ft:qt}),o=!1,De(i))return mn(y,{requestId:f});throw y}}}var Ve=process.env.AWS_REGION,je=Ve?{region:Ve}:{},Sn=new hn(je),In=new yn(je);function _n(e={}){if(!e||e.body===void 0||e.body===null)return{};if(typeof e.body=="object")return e.body;try{let t=e.isBase64Encoded?Buffer.from(e.body,"base64").toString("utf8"):e.body;return JSON.parse(t)}catch{return{}}}function xe(e){return e?e.startsWith("/")?e:`/${e}`:"/api/generate-enhanced-docs"}function An(e={}){let t=e?.requestContext?.http?.method||e?.httpMethod||"POST",n=e?.rawPath||e?.path||"/api/generate-enhanced-docs",r=typeof e.rawQueryString=="string"?e.rawQueryString:"",o=e?.queryStringParameters&&typeof e.queryStringParameters=="object"?{...e.queryStringParameters}:void 0,s=e?.multiValueQueryStringParameters&&typeof e.multiValueQueryStringParameters=="object"?{...e.multiValueQueryStringParameters}:void 0;return{path:xe(n),method:typeof t=="string"?t.toUpperCase():"POST",rawQueryString:r,queryStringParameters:o,multiValueQueryStringParameters:s}}function wn(e={},t={},n={},r){let o=e.headers&&typeof e.headers=="object"?{...e.headers}:{},s=e?.requestContext?.stage||process.env.STAGE_NAME||"prod",i=xe(n.path),a=typeof n.method=="string"?n.method.toUpperCase():"POST",c=typeof n.rawQueryString=="string"?n.rawQueryString:typeof e.rawQueryString=="string"?e.rawQueryString:"",f=(()=>{if(n?.queryStringParameters&&typeof n.queryStringParameters=="object")return{...n.queryStringParameters};if(e?.queryStringParameters&&typeof e.queryStringParameters=="object")return{...e.queryStringParameters}})(),u=(()=>{if(n?.multiValueQueryStringParameters&&typeof n.multiValueQueryStringParameters=="object")return{...n.multiValueQueryStringParameters};if(e?.multiValueQueryStringParameters&&typeof e.multiValueQueryStringParameters=="object")return{...e.multiValueQueryStringParameters}})();return{version:"2.0",routeKey:`${a} ${i}`,rawPath:i,rawQueryString:c,headers:o,queryStringParameters:f,multiValueQueryStringParameters:u,requestContext:{accountId:e?.requestContext?.accountId||"000000000000",apiId:e?.requestContext?.apiId||"local",domainName:e?.requestContext?.domainName||"localhost",domainPrefix:e?.requestContext?.domainPrefix||"local",http:{method:a,path:i,protocol:"HTTP/1.1",sourceIp:e?.requestContext?.http?.sourceIp||"127.0.0.1",userAgent:e?.requestContext?.http?.userAgent||"lambda"},requestId:typeof r=="string"&&r||e?.requestContext?.requestId||Tn(),routeKey:`${a} ${i}`,stage:s,time:new Date().toISOString(),timeEpoch:Date.now()},body:JSON.stringify(t),isBase64Encoded:!1}}function Cn(e={}){return{callbackWaitsForEmptyEventLoop:!1,functionName:e.functionName,functionVersion:e.functionVersion,invokedFunctionArn:e.invokedFunctionArn,memoryLimitInMB:e.memoryLimitInMB,awsRequestId:e.awsRequestId,logGroupName:e.logGroupName,logStreamName:e.logStreamName,identity:e.identity,clientContext:e.clientContext}}function Z(e="",t=""){return typeof e=="string"&&e.trim()?e:typeof t=="string"?t:""}function On(e={}){if(!e||typeof e!="object")return{};let t=Z(e.finalResumeText,Z(e.updatedResumeText,e.resumeText)),n=Z(e.finalJobDescriptionText,e.jobDescriptionText);return{...e,finalResumeText:t,finalJobDescriptionText:n,resumeText:t,jobDescriptionText:n}}function ee(e={},t){if(!e||typeof e!="object")return;let n=String(t||"").toLowerCase();return Object.entries(e).reduce((r,[o,s])=>{if(r!==void 0)return r;if(typeof o=="string"&&o.toLowerCase()===n)return s},void 0)}function te(e){return e==null?"null":typeof e!="object"?JSON.stringify(e):Array.isArray(e)?`[${e.map(o=>te(o)).join(",")}]`:`{${Object.keys(e).sort().map(r=>{let o=te(e[r]);return`${JSON.stringify(r)}:${o}`}).join(",")}}`}function Pe(e,t){let n=Nn("sha256"),r=te({payload:e,route:t});return n.update(r),n.digest("hex")}function Rn(e={},t={},n={}){let r=(()=>{if(typeof e?.requestContext?.requestId=="string"&&e.requestContext.requestId)return e.requestContext.requestId;if(typeof e?.id=="string"&&e.id)return e.id;let o=ee(e?.headers,"x-request-id")||ee(e?.headers,"x-amzn-requestid")||ee(e?.headers,"x-amzn-request-id");if(typeof o=="string"&&o)return o;if(typeof t?.requestId=="string"&&t.requestId)return t.requestId;if(typeof t?.id=="string"&&t.id)return t.id;if(typeof t?.jobId=="string"&&t.jobId)return t.jobId;if(typeof t?.sessionId=="string"&&t.sessionId)return t.sessionId})();return r?String(r):Pe(t,n)}async function Dn(e,t,n,r,o){let s=process.env.DOCUMENT_GENERATION_WORKER_FUNCTION_NAME;if(!s)throw new Error("DOCUMENT_GENERATION_WORKER_FUNCTION_NAME is not configured.");let i=wn(e,n,r,o),a=Cn(t),c={proxyEvent:i,proxyContext:a,requestId:o||i?.requestContext?.requestId},f=new En({FunctionName:s,InvocationType:"RequestResponse",Payload:Buffer.from(JSON.stringify(c))}),u=await In.send(f),d=u?.Payload?Buffer.from(u.Payload).toString("utf8"):"";if(u?.FunctionError){let m=new Error(`Document generation worker invocation failed: ${u.FunctionError}`);throw m.functionError=u.FunctionError,m.payload=d,m}let l={};if(d)try{l=JSON.parse(d)}catch(m){let E=new Error("Document generation worker returned invalid JSON payload.");throw E.cause=m,E.payload=d,E}return{statusCode:Number.parseInt(l?.statusCode,10)||500,headers:l?.headers||{},body:l?.body??"",isBase64Encoded:!!l?.isBase64Encoded}}async function Mn(e,t,n){if(!e)return null;let r=typeof n=="string"&&n?n:Pe(t),o=typeof n=="string"&&n?n:r,s={id:o,requestId:o,type:"document-generation",payload:t,enqueuedAt:new Date().toISOString()};try{await Sn.send(new bn({QueueUrl:e,MessageBody:JSON.stringify(s),MessageGroupId:"document-generation",MessageDeduplicationId:r}))}catch(i){console.warn("Failed to enqueue document generation request",i)}return null}var vn=async(e,t)=>{let n=_n(e),r=On(n),o=An(e),s=process.env.DOCUMENT_GENERATION_QUEUE_URL||"",i=Rn(e,r,o);return s&&await Mn(s,{payload:r,route:o},i),await Dn(e,t,r,o,i)},Ln=Le(vn,{name:"document-generation",operationGroup:"artifact-generation",captureErrorTrace:!0}),pr=Ln;export{pr as default,Ln as handler};
