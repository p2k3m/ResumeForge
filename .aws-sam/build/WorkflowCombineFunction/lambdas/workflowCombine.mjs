import { createRequire as __createRequire } from 'module';
import { fileURLToPath as __fileURLToPath } from 'url';
import path from 'path';
const require = __createRequire(import.meta.url);
const __filename = __fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
globalThis.__filename = globalThis.__filename || __filename;
globalThis.__dirname = globalThis.__dirname || __dirname;
var $e=Object.create;var ne=Object.defineProperty;var Fe=Object.getOwnPropertyDescriptor;var Pe=Object.getOwnPropertyNames;var ze=Object.getPrototypeOf,Ke=Object.prototype.hasOwnProperty;var V=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var re=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var qe=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Pe(t))!Ke.call(e,s)&&s!==n&&ne(e,s,{get:()=>t[s],enumerable:!(r=Fe(t,s))||r.enumerable});return e};var He=(e,t,n)=>(n=e!=null?$e(ze(e)):{},qe(t||!e||!e.__esModule?ne(n,"default",{value:e,enumerable:!0}):n,e));var se=re((vn,We)=>{We.exports={name:"dotenv",version:"16.6.1",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=text --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},homepage:"https://github.com/motdotla/dotenv#readme",funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var ue=re((Rn,C)=>{var H=V("fs"),U=V("path"),Ye=V("os"),Ge=V("crypto"),Je=se(),W=Je.version,Qe=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function Xe(e){let t={},n=e.toString();n=n.replace(/\r\n?/mg,`
`);let r;for(;(r=Qe.exec(n))!=null;){let s=r[1],i=r[2]||"";i=i.trim();let o=i[0];i=i.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),o==='"'&&(i=i.replace(/\\n/g,`
`),i=i.replace(/\\r/g,"\r")),t[s]=i}return t}function Ze(e){e=e||{};let t=ce(e);e.path=t;let n=m.configDotenv(e);if(!n.parsed){let o=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw o.code="MISSING_DATA",o}let r=ae(e).split(","),s=r.length,i;for(let o=0;o<s;o++)try{let a=r[o].trim(),l=tt(n,a);i=m.decrypt(l.ciphertext,l.key);break}catch(a){if(o+1>=s)throw a}return m.parse(i)}function et(e){console.log(`[dotenv@${W}][WARN] ${e}`)}function L(e){console.log(`[dotenv@${W}][DEBUG] ${e}`)}function ie(e){console.log(`[dotenv@${W}] ${e}`)}function ae(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function tt(e,t){let n;try{n=new URL(t)}catch(a){if(a.code==="ERR_INVALID_URL"){let l=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw l.code="INVALID_DOTENV_KEY",l}throw a}let r=n.password;if(!r){let a=new Error("INVALID_DOTENV_KEY: Missing key part");throw a.code="INVALID_DOTENV_KEY",a}let s=n.searchParams.get("environment");if(!s){let a=new Error("INVALID_DOTENV_KEY: Missing environment part");throw a.code="INVALID_DOTENV_KEY",a}let i=`DOTENV_VAULT_${s.toUpperCase()}`,o=e.parsed[i];if(!o){let a=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${i} in your .env.vault file.`);throw a.code="NOT_FOUND_DOTENV_ENVIRONMENT",a}return{ciphertext:o,key:r}}function ce(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let n of e.path)H.existsSync(n)&&(t=n.endsWith(".vault")?n:`${n}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=U.resolve(process.cwd(),".env.vault");return H.existsSync(t)?t:null}function oe(e){return e[0]==="~"?U.join(Ye.homedir(),e.slice(1)):e}function nt(e){let t=!!(e&&e.debug),n=e&&"quiet"in e?e.quiet:!0;(t||!n)&&ie("Loading env from encrypted .env.vault");let r=m._parseVault(e),s=process.env;return e&&e.processEnv!=null&&(s=e.processEnv),m.populate(s,r,e),{parsed:r}}function rt(e){let t=U.resolve(process.cwd(),".env"),n="utf8",r=!!(e&&e.debug),s=e&&"quiet"in e?e.quiet:!0;e&&e.encoding?n=e.encoding:r&&L("No encoding is specified. UTF-8 is used by default");let i=[t];if(e&&e.path)if(!Array.isArray(e.path))i=[oe(e.path)];else{i=[];for(let u of e.path)i.push(oe(u))}let o,a={};for(let u of i)try{let c=m.parse(H.readFileSync(u,{encoding:n}));m.populate(a,c,e)}catch(c){r&&L(`Failed to load ${u} ${c.message}`),o=c}let l=process.env;if(e&&e.processEnv!=null&&(l=e.processEnv),m.populate(l,a,e),r||!s){let u=Object.keys(a).length,c=[];for(let d of i)try{let f=U.relative(process.cwd(),d);c.push(f)}catch(f){r&&L(`Failed to load ${d} ${f.message}`),o=f}ie(`injecting env (${u}) from ${c.join(",")}`)}return o?{parsed:a,error:o}:{parsed:a}}function st(e){if(ae(e).length===0)return m.configDotenv(e);let t=ce(e);return t?m._configVault(e):(et(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),m.configDotenv(e))}function ot(e,t){let n=Buffer.from(t.slice(-64),"hex"),r=Buffer.from(e,"base64"),s=r.subarray(0,12),i=r.subarray(-16);r=r.subarray(12,-16);try{let o=Ge.createDecipheriv("aes-256-gcm",n,s);return o.setAuthTag(i),`${o.update(r)}${o.final()}`}catch(o){let a=o instanceof RangeError,l=o.message==="Invalid key length",u=o.message==="Unsupported state or unable to authenticate data";if(a||l){let c=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw c.code="INVALID_DOTENV_KEY",c}else if(u){let c=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw c.code="DECRYPTION_FAILED",c}else throw o}}function it(e,t,n={}){let r=!!(n&&n.debug),s=!!(n&&n.override);if(typeof t!="object"){let i=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw i.code="OBJECT_REQUIRED",i}for(let i of Object.keys(t))Object.prototype.hasOwnProperty.call(e,i)?(s===!0&&(e[i]=t[i]),r&&L(s===!0?`"${i}" is already defined and WAS overwritten`:`"${i}" is already defined and was NOT overwritten`)):e[i]=t[i]}var m={configDotenv:rt,_configVault:nt,_parseVault:Ze,config:st,decrypt:ot,parse:Xe,populate:it};C.exports.configDotenv=m.configDotenv;C.exports._configVault=m._configVault;C.exports._parseVault=m._parseVault;C.exports.config=m.config;C.exports.decrypt=m.decrypt;C.exports.parse=m.parse;C.exports.populate=m.populate;C.exports=m});var me=He(ue(),1);import dt from"fs";import ft from"path";import T from"process";import b from"node:process";function y(e){return typeof e=="string"&&e.trim().length>0}function R(e){return typeof e=="string"?e.trim():""}var le=new Map(Object.entries({development:"dev",dev:"dev",production:"prod",prod:"prod",staging:"stage",stage:"stage",testing:"test",test:"test"}));function O(e){let t=R(e).toLowerCase();return t?le.has(t)?le.get(t):t:""}function at(){let e=R(b.env.NODE_ENV);return O(e)}function de(){if(y(b.env.STAGE_NAME)){let t=O(b.env.STAGE_NAME);if(t)return t}if(y(b.env.DEPLOYMENT_ENVIRONMENT)){let t=O(b.env.DEPLOYMENT_ENVIRONMENT);if(t)return t}let e=at();return e||"dev"}function ct({stageName:e}={}){if(y(b.env.DEPLOYMENT_ENVIRONMENT)){let n=O(b.env.DEPLOYMENT_ENVIRONMENT);if(n)return n}let t=y(e)?O(e):de();return t||"dev"}function fe(){return y(b.env.DATA_BUCKET)?R(b.env.DATA_BUCKET):y(b.env.S3_BUCKET)?R(b.env.S3_BUCKET):""}function ut({dataBucket:e}={}){if(y(b.env.STATIC_ASSETS_BUCKET))return R(b.env.STATIC_ASSETS_BUCKET);if(y(e))return R(e);let t=fe();return t||""}function lt(){return y(b.env.LOGS_BUCKET)?R(b.env.LOGS_BUCKET):""}function A(e,t){typeof e=="string"&&y(t)&&(b.env[e]=R(t))}function pe({propagateToProcessEnv:e=!0,propagateViteEnv:t=!1}={}){let n=de(),r=ct({stageName:n}),s=fe(),i=ut({dataBucket:s}),o=lt();return e&&(A("STAGE_NAME",n),A("DEPLOYMENT_ENVIRONMENT",r),y(s)&&A("S3_BUCKET",s),y(i)&&A("STATIC_ASSETS_BUCKET",i),y(o)&&A("LOGS_BUCKET",o)),t&&(A("VITE_STAGE_NAME",n),A("VITE_DEPLOYMENT_ENVIRONMENT",r),y(s)&&(A("VITE_S3_BUCKET",s),A("VITE_DATA_BUCKET",s)),y(i)&&A("VITE_STATIC_ASSETS_BUCKET",i),y(o)&&A("VITE_LOGS_BUCKET",o)),{stageName:n,deploymentEnvironment:r,dataBucket:s,staticAssetsBucket:i,logsBucket:o}}function x(e){return typeof e=="string"&&e.trim().length>0}var pt=x(T.env.NODE_ENV)?T.env.NODE_ENV.trim().toLowerCase():"development",mt=!!T.env.AWS_LAMBDA_FUNCTION_NAME,ht=!mt&&(pt==="development"||!x(T.env.NODE_ENV));if(ht){let e=ft.resolve(T.cwd(),".env");dt.existsSync(e)&&me.default.config({path:e})}var he=["S3_BUCKET","GEMINI_API_KEY"],gt=["CLOUDFRONT_ORIGINS"],Y=he.filter(e=>!x(T.env[e]));gt.forEach(e=>{x(T.env[e])||console.warn(`Optional environment value ${e} is not set. Provide it via the runtime config file or environment to enable strict CORS.`)});!x(T.env.AWS_REGION)&&x(T.env.AWS_DEFAULT_REGION)&&(T.env.AWS_REGION=T.env.AWS_DEFAULT_REGION.trim());x(T.env.AWS_REGION)||Y.push("AWS_REGION");if(Y.length>0)throw new Error(`Missing required environment variables: ${Y.join(", ")}. Ensure they are configured via deployment secrets or a local .env file.`);var{stageName:Dn,deploymentEnvironment:yt}=pe({propagateToProcessEnv:!0,propagateViteEnv:!1});function bt(e){let t=new URLSearchParams(e||"");return t.set("environment",yt),t.toString()}function D(e={}){return{...e,Tagging:bt(e.Tagging)}}var kn=Object.freeze([...he,"AWS_REGION"]);var Bn=new Set("a,an,and,are,as,at,be,by,for,from,has,have,in,is,it,of,on,or,that,the,to,with,will,our,your,they,them,into,about,over,more,than,who,what,when,where,which,were,while,within,under,across,through,using,per".split(",").map(e=>e.trim()));var ge=["improve-summary","add-missing-skills","change-designation","align-experience","improve-certifications","improve-projects","improve-highlights"],Et={summary:["summary","professional summary","profile"],skills:["skills","key skills","core skills"],experience:["experience","work experience","professional experience"],certifications:["certifications","licenses"],projects:["projects","key projects"],highlights:["highlights","key highlights","career highlights"]};function wt(e){return typeof e=="string"?e.replace(/\s+/g," ").trim():""}function k(e){return e?Array.isArray(e)?e.map(t=>String(t||"")):String(e||"").replace(/\r/g,"").split(`
`):[]}function I(e){return wt(e).replace(/:$/,"").toLowerCase()}function St(e,t){if(!Array.isArray(e)||!e.length)return{index:-1,matchedLabel:""};let n=t.map(r=>I(r));for(let r=0;r<e.length;r+=1){let s=I(e[r]);if(s&&n.includes(s))return{index:r,matchedLabel:e[r]}}return{index:-1,matchedLabel:""}}function ye(e,t){let{index:n}=St(e,t);if(n===-1)return{start:-1,end:-1};let r=e.length;for(let s=n+1;s<e.length;s+=1){let i=I(e[s]);if(!i){r=s;break}if(Object.values(Et).some(a=>a.some(l=>I(l)===i))){r=s;break}}return{start:n,end:r}}function Tt(e,t,n){let r=k(e),{start:s,end:i}=ye(r,t),o=Array.isArray(n)?n:k(n);if(s===-1){let l=t[0]?t[0].toUpperCase():"SUMMARY",u=[...r];return u.length&&u[u.length-1].trim()&&u.push(""),u.push(l.toUpperCase()),u.push(...o),u.join(`
`)}let a=[...r];return a.splice(s,Math.max(i-s,1),r[s],...o),a.join(`
`)}function At(e,t){let n=k(e);if(!n.length)return t||"";let r=[...n];return r[0]=t?t.toUpperCase():n[0],r.join(`
`)}function Nt(e,t,n){let r=k(e),s=Array.isArray(n)?n:k(n),{start:i}=ye(r,t),o=[...r];if(i===-1){let c=t[0]?t[0].toUpperCase():"SECTION";return o.length&&o[o.length-1].trim()&&o.push(""),o.push(c.toUpperCase()),o.push(...s),o.join(`
`)}let a=new Set;for(let c=i+1;c<o.length;c+=1){let d=I(o[c]);if(!d)break;a.add(d)}let l=i+1,u=s.filter(c=>{let d=I(c);return!d||a.has(d)?!1:(a.add(d),!0)});return u.length?(o.splice(l,0,...u),o.join(`
`)):e}function be(e,t){if(!t||typeof t!="object")return e;let n=t.op;return n==="replace-section"?Tt(e,t.sectionLabels||[],t.lines||[]):n==="append-unique-lines"?Nt(e,t.sectionLabels||[],t.lines||[]):n==="replace-first-line"?At(e,t.value||""):e}function Ee(e){return Array.isArray(e)&&e.length?e.filter(t=>ge.includes(t)):[...ge]}import{CloudWatchClient as zt,PutMetricDataCommand as Z}from"@aws-sdk/client-cloudwatch";import{S3Client as Kt}from"@aws-sdk/client-s3";import{randomUUID as je}from"crypto";import{GetObjectCommand as Ut,PutObjectCommand as xe}from"@aws-sdk/client-s3";var we=new Set(["ECONNRESET","ECONNREFUSED","ETIMEDOUT","EPIPE","EAI_AGAIN","ENOTFOUND","ECONNABORTED","ENETUNREACH","EHOSTUNREACH"]),Se=new Set(["SLOWDOWN","SLOWDOWNERROR","REQUESTTIMEOUT","THROTTLING","THROTTLINGEXCEPTION","SERVICEUNAVAILABLE","INTERNALERROR"]);function Ct(e){return new Promise(t=>setTimeout(t,e))}function $(e){if(!(!e||typeof e!="object")){if(typeof e.status=="number")return e.status;if(typeof e.statusCode=="number")return e.statusCode;if(typeof e.$metadata?.httpStatusCode=="number")return e.$metadata.httpStatusCode;if(typeof e.response?.status=="number")return e.response.status;if(typeof e.cause?.status=="number")return e.cause.status;if(typeof e.cause?.statusCode=="number")return e.cause.statusCode}}function vt(e){return Number.isFinite(e)?e===429||e>=500:!1}function Rt(e){if(!e||typeof e!="object")return!1;let t=typeof e.code=="string"?e.code.toUpperCase():"";if(t&&we.has(t))return!0;let n=typeof e.name=="string"?e.name.toUpperCase():"";if(n&&we.has(n))return!0;let r=typeof e.message=="string"?e.message.toLowerCase():"";return r?r.includes("timed out")||r.includes("timeout")||r.includes("temporarily unavailable")||r.includes("connection reset")||r.includes("socket hang up"):!1}function G(e){if(!e||typeof e!="object")return!1;let t=$(e);if(vt(t)||Rt(e))return!0;let n=typeof e.code=="string"?e.code.toUpperCase():"";if(n&&Se.has(n))return!0;let r=typeof e.name=="string"?e.name.toUpperCase():"";return!!(r&&Se.has(r))}async function J(e,t={}){let{maxAttempts:n=3,baseDelayMs:r=500,maxDelayMs:s=5e3,jitterMs:i=250,shouldRetry:o=()=>!1,onRetry:a}=t,l;for(let u=1;u<=n;u+=1)try{return await e(u)}catch(c){if(l=c,!(u<n&&o(c,u)))throw c;let f=r*2**(u-1),E=Math.min(s,f),S=i>0?Math.floor(Math.random()*i):0,h=Math.max(0,E+S);if(typeof a=="function")try{a(c,u,h)}catch{}await Ct(h)}throw l}import{randomBytes as $t,randomUUID as Ce}from"crypto";import v from"node:process";var F=null;function Te(e=[]){for(let t of e)if(typeof t=="string"){let n=t.trim();if(n)return n}return null}function xt(e){if(!e)return null;let t=new Date(e);return Number.isNaN(t.getTime())?null:t.toISOString()}function It(){let e=[v.env.BUILD_TIMESTAMP,v.env.DEPLOY_TIMESTAMP];for(let t of e){let n=xt(t);if(n)return n}return new Date().toISOString()}function _t(){if(F)return F;let e=Te([v.env.BUILD_VERSION,v.env.VERSION,v.env.npm_package_version]),t=Te([v.env.BUILD_SHA,v.env.GIT_COMMIT,v.env.GIT_SHA,v.env.GITHUB_SHA]),n=It();return F={version:e||null,sha:t||null,timestamp:n},F}function Q(e,{fallback:t="unknown"}={}){return typeof e=="string"&&e.trim()?e.trim():typeof e=="number"&&Number.isFinite(e)?String(e):t}function Ae({versionLabel:e}={}){let{version:t,sha:n,timestamp:r}=_t(),s={"build-timestamp":Q(r,{fallback:new Date().toISOString()}),"build-version":Q(t||e),"build-sha":Q(n)};return typeof e=="string"&&e.trim()&&(s["asset-version-label"]=e.trim()),s}function Mt(e={}){let t=Ae(e),n=typeof t["build-sha"]=="string"?t["build-sha"].trim():"",r=typeof t["build-timestamp"]=="string"?t["build-timestamp"].trim():"",s=[];return n&&s.push({Key:"build",Value:n}),r&&s.push({Key:"deployed",Value:r}),s}function Lt(e,t=[]){let n=new URLSearchParams(e||"");for(let r of t){if(!r||typeof r.Key!="string")continue;let s=r.Key.trim();if(!s)continue;let i=typeof r.Value=="string"?r.Value.trim():"";i&&n.set(s,i)}return n.toString()}function X(e={},t={}){let n=Ae(t),r=e&&typeof e=="object"&&typeof e.Metadata=="object"&&e.Metadata!==null&&!Array.isArray(e.Metadata)?e.Metadata:{},s=Lt(e?.Tagging,Mt(t)),i={...e,Metadata:{...r,...n}};return s&&(i.Tagging=s),i}function N(e){return e==null?"":typeof e=="string"?e.trim():typeof e=="number"||typeof e=="bigint"?String(e):""}function j(...e){for(let t of e){let n=N(t);if(n)return n}return""}function Ot(){return j(process.env.RESUMEFORGE_BUILD_ID,process.env.BUILD_ID,process.env.DEPLOYMENT_BUILD_ID,process.env.GITHUB_RUN_ID,process.env.GITHUB_SHA,process.env.AWS_LAMBDA_FUNCTION_VERSION)||"local-dev"}var Dt=Ot();function kt(e={}){return j(e.build,e.buildId,e.metadata?.build,e.metadata?.buildId)||Dt}function jt(e={}){let t=n=>Array.isArray(n)&&n.length?n[0]:"";return j(e.template,e.templateId,e.resumeTemplate,e.coverTemplate,e.preferredTemplate,e.canonicalSelectedTemplate,e.selectedTemplate,e.template1,e.template2,t(e.templates),t(e.availableCvTemplates),e.coverTemplate1,e.coverTemplate2)||"unknown"}function Bt(e={}){return j(e.session,e.sessionId,e.jobId,e.requestId,e.detail?.sessionId,e.detail?.jobId,e.metadata?.session,e.metadata?.sessionId)||"unknown"}function Vt(e={}){let t=Array.isArray(e.urls)?e.urls:[],n=t.length>0?N(t[0]?.type):"",r=()=>{let s=N(e.event);return s?s.includes("cover_letter")?"cover_letter":s.includes("generation_artifacts")?"generated_artifact":s.includes("initial_upload")?"upload_artifact":"":""};return j(e.artifactType,e.metadata?.artifactType,e.type,e.cleanupEvent,n,r())||"none"}function P(e={},t={},n={}){let{embedMetadata:r=!0}=n;if(!e||typeof e!="object")return e;let s={...typeof e.metadata=="object"&&e.metadata?e.metadata:{},...typeof t.metadata=="object"&&t.metadata?t.metadata:{}},i={...s,...e,...t},o=jt(i),a=Bt(i),l=kt({...i,metadata:s}),u=Vt(i),c={...e};N(c.template)||(c.template=o),N(c.session)||(c.session=a),N(c.build)||(c.build=l),N(c.artifactType)||(c.artifactType=u);let d={...s};return N(d.template)||(d.template=o),N(d.session)||(d.session=a),N(d.build)||(d.build=l),N(d.artifactType)||(d.artifactType=u),r?(Object.keys(d).length>0&&(c.metadata=d),c):d}function Ne(e={},t={}){let n=P(e,t,{embedMetadata:!1});return!n||typeof n!="object"?{}:n}async function Ft(e){return await new Promise((t,n)=>{let r=[];e.on("data",s=>r.push(s)),e.on("error",n),e.on("end",()=>t(Buffer.concat(r).toString("utf-8")))})}async function Ie({s3:e,bucket:t,key:n,jobId:r,event:s,level:i="info",message:o,metadata:a,template:l,session:u,build:c,artifactType:d}){let f={jobId:r,template:l,session:u,build:c,artifactType:d},E=a&&typeof a=="object"&&!Array.isArray(a)?a:{},S=Ne(E,f),h=P({timestamp:new Date().toISOString(),jobId:r,event:s,level:i,...o?{message:o}:{},metadata:S},f),w="";try{let g=await e.send(new Ut({Bucket:t,Key:n}));w=await Ft(g.Body)}catch(g){if(g.name!=="NoSuchKey"&&g.$metadata?.httpStatusCode!==404)throw g}let p=w+JSON.stringify(h)+`
`;await J(()=>e.send(new xe(D(X({Bucket:t,Key:n,Body:p,ContentType:"application/json"})))),{maxAttempts:4,baseDelayMs:500,maxDelayMs:4e3,jitterMs:300,shouldRetry:g=>G(g),onRetry:(g,Ve,Ue)=>{console.warn("Retrying S3 log upload",{bucket:t,key:n,attempt:Ve,delayMs:Ue,status:$(g),code:g?.code})}})}function ve(){if(typeof Ce=="function")try{return Ce()}catch{}return $t(16).toString("hex")}function Re(e){return e?String(e).trim().replace(/[^a-zA-Z0-9._-]+/g,"-").replace(/^-+|-+$/g,"").slice(0,80):""}function Pt(e=""){if(!e)return"";let t=e.replace(/^\/+/,"").replace(/\/+/g,"/");return t.endsWith("/")?t:`${t}/`}async function _e({s3:e,bucket:t,entry:n,prefix:r="logs/errors/",key:s}){if(!e||!t||!n)return;let i=typeof n?.timestamp=="string"&&n.timestamp.trim()?n.timestamp:new Date().toISOString(),o=i.slice(0,10),a=Re(n.requestId)||ve(),l=Re(i)||ve(),u=Pt(r),c=typeof s=="string"&&s.trim()?s.trim():`${u}${o}/${l}-${a}.json`,d=P({...n,timestamp:i},{jobId:n?.jobId,template:n?.template,session:n?.session,build:n?.build,artifactType:n?.artifactType,metadata:n?.metadata});await J(()=>e.send(new xe(D(X({Bucket:t,Key:c,Body:JSON.stringify(d),ContentType:"application/json"})))),{maxAttempts:4,baseDelayMs:500,maxDelayMs:4e3,jitterMs:300,shouldRetry:f=>G(f),onRetry:(f,E,S)=>{console.warn("Retrying S3 trace upload",{bucket:t,key:s,attempt:E,delayMs:S,status:$(f),code:f?.code})}})}var B=process.env.AWS_REGION||process.env.AWS_DEFAULT_REGION||void 0,z=B?new zt({region:B}):null,q=B?new Kt({region:B}):null,Me=process.env.METRICS_NAMESPACE||"ResumeForge/Operations",qt=process.env.ARTIFACT_METRICS_NAMESPACE||"ResumeForge/Artifacts",ee=process.env.SESSION_CHANGE_LOG_PREFIX||"logs/sessions/",Ht=process.env.LAMBDA_ERROR_TRACE_PREFIX||"logs/errors/",Wt=process.env.ARTIFACT_FAILURE_LOG_PREFIX||"logs/artifact-failures/",M=process.env.LOGS_BUCKET||process.env.S3_BUCKET||"",_=process.env.STAGE_NAME||process.env.DEPLOYMENT_ENVIRONMENT||"prod",Yt=/^\/(?:assets|fonts|images|cover-templates)(?:\b|\/)/i,Le=Object.freeze({"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token","Access-Control-Allow-Methods":"OPTIONS,GET,POST"}),Gt="An unexpected error occurred. Please try again later.",Jt="The request could not be completed.";function Qt(e={},t={}){return e?.requestContext?.requestId||e?.headers?.["x-amzn-requestid"]||e?.headers?.["x-amzn-request-id"]||t?.awsRequestId||je()}function Xt(e={}){if(!e||typeof e!="object")return"";if(typeof e.sessionId=="string"&&e.sessionId.trim())return e.sessionId.trim();if(typeof e.jobId=="string"&&e.jobId.trim())return e.jobId.trim();if(typeof e.detail=="object"&&e.detail){let t=e.detail;if(typeof t.sessionId=="string"&&t.sessionId.trim())return t.sessionId.trim();if(typeof t.jobId=="string"&&t.jobId.trim())return t.jobId.trim()}if(Array.isArray(e.Records)&&e.Records.length>0){let t=e.Records[0];if(t&&typeof t.body=="string")try{let n=JSON.parse(t.body);if(n&&typeof n=="object"){if(typeof n.sessionId=="string"&&n.sessionId.trim())return n.sessionId.trim();if(typeof n.jobId=="string"&&n.jobId.trim())return n.jobId.trim();if(n.payload&&typeof n.payload=="object"&&typeof n.payload.jobId=="string"&&n.payload.jobId.trim())return n.payload.jobId.trim()}}catch{}}return""}function Zt(e=""){return String(e).trim().replace(/[^a-zA-Z0-9._-]+/g,"-").replace(/^-+|-+$/g,"").slice(0,120)}function en(e,t){let n=e||t;if(!n)return"";let r=Zt(n);return`${ee.endsWith("/")?ee:`${ee}/`}${r}.jsonl`}function tn(e={}){return e?.requestContext?.http?{type:"http",method:e.requestContext.http.method,path:e.requestContext.http.path,protocol:e.requestContext.http.protocol,sourceIp:e.requestContext.http.sourceIp,userAgent:e.requestContext.http.userAgent}:typeof e.httpMethod=="string"&&typeof e.path=="string"?{type:"http-legacy",method:e.httpMethod,path:e.path}:Array.isArray(e.Records)?{type:"records",recordCount:e.Records.length,sources:Array.from(new Set(e.Records.map(t=>t.eventSource||t.EventSource||t.source).filter(Boolean)))}:e?.detailType||e?.source?{type:"event-bridge",detailType:e.detailType,source:e.source}:e?.source==="aws.states"?{type:"step-functions"}:{type:typeof e}}function nn(e){if(!e||typeof e!="object")return{};let t={};for(let[n,r]of Object.entries(e))typeof n=="string"&&(t[n.toLowerCase()]=r);return t}function Oe(e){if(typeof e!="string")return null;let t=e.trim();if(!t||!t.startsWith("{")&&!t.startsWith("["))return null;try{return JSON.parse(t)}catch{return null}}function rn(e){return e&&Array.isArray(e)?e.filter(t=>t!=null).length:0}function sn(e){if(!e||typeof e!="object")return 0;let t=[e.sessionCount,e.totalSessions,e.sessions?.length,e.sessionLogs?.length].filter(r=>Number.isFinite(r)&&r>0),n=t.length?Math.max(...t.map(r=>Number(r))):0;return typeof e.sessionId=="string"&&e.sessionId.trim()&&(n=Math.max(n,1)),Array.isArray(e.sessionIds)&&(n=Math.max(n,e.sessionIds.length)),Array.isArray(e.sessions)&&(n=Math.max(n,e.sessions.length)),Array.isArray(e.sessionLogs)&&(n=Math.max(n,e.sessionLogs.length)),n}var on=["urls","downloads","downloadUrls","download_logs","downloadLogs","files","artifacts","links"],an=["downloadCount","totalDownloads","downloadTotal"];function cn(e){if(!e||typeof e!="object")return 0;let t=0;for(let n of an){let r=e[n];Number.isFinite(r)&&r>0&&(t=Math.max(t,Number(r)))}for(let n of on)Array.isArray(e[n])&&(t=Math.max(t,rn(e[n])));return t}function un(e={},t={}){return typeof t?.path=="string"&&t.path?t.path:typeof e?.rawPath=="string"&&e.rawPath?e.rawPath:typeof e?.path=="string"&&e.path?e.path:typeof e?.requestContext?.http?.path=="string"?e.requestContext.http.path:""}function ln(e={},t={}){return typeof t?.method=="string"&&t.method?t.method:typeof e?.requestContext?.http?.method=="string"?e.requestContext.http.method:typeof e?.httpMethod=="string"?e.httpMethod:""}function dn(e=""){if(typeof e!="string"||!e)return"unknown";if(e==="/"||e==="")return"root";if(e.startsWith("/api/")){let[,,t]=e.split("/",3);return t?`/api/${t}`:"/api"}return e.startsWith("/assets")?"/assets":e.startsWith("/fonts")?"/fonts":e.startsWith("/images")?"/images":e.startsWith("/cover-templates")?"/cover-templates":e.split("?")[0]||"unknown"}function fn(e,{event:t,requestMetadata:n,durationMs:r}={}){if(!e||typeof e!="object")return null;let s=nn(e.headers),i=Number.isInteger(e.statusCode)?Number(e.statusCode):void 0,o=ln(t,n),a=un(t,n),l=s["content-length"],u=l!==void 0?Number(l):!e.isBase64Encoded&&typeof e.body=="string"?Buffer.byteLength(e.body):void 0,c=null,d=s["content-type"],f=typeof d=="string"&&/json/i.test(d);!e.isBase64Encoded&&typeof e.body=="string"&&e.body&&(c=Oe(e.body));let E=sn(c),S=cn(c),h=dn(a),w=Yt.test(a);return{statusCode:i,method:o,path:a,pathCategory:h,contentLength:Number.isFinite(u)?u:void 0,sessionCount:Number.isFinite(E)&&E>0?E:0,downloadCount:Number.isFinite(S)&&S>0?S:0,isAssetRequest:w,durationMs:Number.isFinite(r)?r:void 0}}function pn(e={}){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([,t])=>t!=null))}function De(e={}){return!e||typeof e!="object"?!1:!!(typeof e.httpMethod=="string"||e?.requestContext?.http&&typeof e.requestContext.http.method=="string"||typeof e.version=="string"&&e.version.startsWith("2")&&(typeof e.rawPath=="string"||typeof e.routeKey=="string")||typeof e.rawPath=="string"&&typeof e.requestContext=="object"||typeof e.resource=="string"&&typeof e.path=="string")}function mn(e){return[e?.statusCode,e?.status,e?.httpStatus,e?.response?.status,e?.output?.statusCode].find(r=>Number.isInteger(r)&&r>=400&&r<=599)??500}function hn(e,t){return typeof e?.code=="string"&&e.code.trim()?e.code.trim():t>=500?"INTERNAL_SERVER_ERROR":"BAD_REQUEST"}function gn(e,t){return typeof e?.message=="string"&&e.message.trim()?e.message.trim():t>=500?Gt:Jt}function yn(e){if(e?.details!==void 0)return e.details;if(e?.errors!==void 0)return e.errors;if(e?.data!==void 0)return e.data;if(e?.response?.data!==void 0)return e.response.data}function bn(e){return!e||typeof e!="object"?{...Le}:{...Le,...e}}function En(e,{requestId:t}={}){let n=mn(e),r=hn(e,n),s=gn(e,n),i=yn(e),o={success:!1,code:r,message:s,...i!==void 0?{details:i}:{},...t?{requestId:t}:{}},a;if(typeof e?.body=="string")a=e.body;else if(e?.body&&typeof e.body=="object")try{a=JSON.stringify(e.body)}catch{a=JSON.stringify(o)}else a=JSON.stringify(o);return{statusCode:n,headers:bn(e?.headers),body:a,isBase64Encoded:!!(e?.isBase64Encoded&&a===e?.body)}}function wn(e,t,n){if(!e)return[];let r=(i={})=>{let o=t.map(a=>({...a}));e.pathCategory&&o.push({Name:"Path",Value:e.pathCategory}),e.method&&o.push({Name:"Method",Value:e.method}),e.isAssetRequest&&o.push({Name:"AssetRequest",Value:"true"});for(let[a,l]of Object.entries(i))typeof a=="string"&&typeof l=="string"&&o.push({Name:a,Value:l});return o},s=[];return e.isAssetRequest&&Number.isFinite(e.durationMs)&&s.push({MetricName:"AssetResponseDuration",Dimensions:r(),Timestamp:n,Unit:"Milliseconds",Value:e.durationMs}),e.statusCode===404&&s.push({MetricName:"HttpNotFound",Dimensions:r(),Timestamp:n,Unit:"Count",Value:1}),Number.isFinite(e.sessionCount)&&e.sessionCount>0&&s.push({MetricName:"SessionCount",Dimensions:r({Detail:"Sessions"}),Timestamp:n,Unit:"Count",Value:e.sessionCount}),Number.isFinite(e.downloadCount)&&e.downloadCount>0&&s.push({MetricName:"DownloadCount",Dimensions:r({Detail:"Downloads"}),Timestamp:n,Unit:"Count",Value:e.downloadCount}),s}async function ke({functionName:e,durationMs:t,success:n,coldStart:r,operationGroup:s,httpSummary:i}){if(!z||!B)return;let o=new Date,a=[{Name:"FunctionName",Value:e},{Name:"Stage",Value:_}];s&&a.push({Name:"Operation",Value:s});let l=[{MetricName:"InvocationDuration",Dimensions:a,Timestamp:o,Unit:"Milliseconds",Value:t},{MetricName:"InvocationCount",Dimensions:[...a,{Name:"Status",Value:n?"Success":"Failure"}],Timestamp:o,Unit:"Count",Value:1}];r&&l.push({MetricName:"ColdStart",Dimensions:a,Timestamp:o,Unit:"Count",Value:1});try{await z.send(new Z({Namespace:Me,MetricData:l}))}catch(f){console.warn("Failed to publish lambda metrics",{functionName:e,stage:_,errorMessage:f?.message})}let u=wn(i,a,o);if(u.length)try{await z.send(new Z({Namespace:Me,MetricData:u}))}catch(f){console.warn("Failed to publish HTTP summary metrics",{functionName:e,stage:_,errorMessage:f?.message})}if(!s)return;let c=n?"Success":"Failure",d=[{MetricName:`${s.replace(/-/g," ").replace(/\s+/g,"")}${c}`,Dimensions:[{Name:"Operation",Value:s},{Name:"Stage",Value:_}],Timestamp:o,Unit:"Count",Value:1}];try{await z.send(new Z({Namespace:qt,MetricData:d}))}catch(f){console.warn("Failed to publish artifact metrics",{operationGroup:s,stage:_,errorMessage:f?.message})}}async function K({sessionId:e,requestId:t,jobId:n,event:r,metadata:s}){if(!q||!M)return;let i=en(e,t);if(i)try{await Ie({s3:q,bucket:M,key:i,jobId:n||e||t,event:r,metadata:D({...s,stage:_})})}catch(o){console.warn("Failed to append session change log",{key:i,bucket:M,event:r,errorMessage:o?.message})}}async function Sn({error:e,requestId:t,sessionId:n,jobId:r,functionName:s,operationGroup:i,metadata:o,prefix:a}){if(!q||!M||!e)return;let l={requestId:t,sessionId:n,jobId:r,functionName:s,operationGroup:i,message:e.message,stack:e.stack,metadata:o};try{await _e({s3:q,bucket:M,entry:l,prefix:a})}catch(u){console.warn("Failed to upload lambda error trace",{functionName:s,bucket:M,errorMessage:u?.message})}}function Be(e,{name:t="lambda-function",operationGroup:n,captureErrorTrace:r=!1}={}){if(typeof e!="function")throw new TypeError("withLambdaObservability expects a handler function.");let s=!0;return async function(o,a){let l=a?.functionName||t,u=Qt(o,a),c=Xt(o),d=typeof o?.jobId=="string"?o.jobId:"",f=je(),E=tn(o);console.info("Lambda invocation started",{invocationId:f,functionName:l,requestId:u,sessionId:c,jobId:d,coldStart:s,operationGroup:n,requestMetadata:E}),await K({sessionId:c,requestId:u,jobId:d,event:"lambda_invocation_started",metadata:{invocationId:f,functionName:l,operationGroup:n,coldStart:s,requestMetadata:E}});let S=Date.now();try{let h=await e(o,a),w=Date.now()-S;console.info("Lambda invocation completed",{invocationId:f,functionName:l,requestId:u,sessionId:c,jobId:d,durationMs:w,operationGroup:n,coldStart:s});let p=De(o)?fn(h,{event:o,requestMetadata:E,durationMs:w}):null;if(p){let g=pn({invocationId:f,functionName:l,requestId:u,sessionId:c,jobId:d,operationGroup:n,durationMs:w,method:p.method,path:p.path,pathCategory:p.pathCategory,statusCode:p.statusCode,contentLength:p.contentLength,sessionCount:p.sessionCount,downloadCount:p.downloadCount,assetRequest:p.isAssetRequest||void 0});console.info("API gateway response summary",g),p.isAssetRequest&&console.info("API gateway asset response",g),p.statusCode===404&&console.warn("API gateway not found response",g),(Number.isFinite(p.sessionCount)&&p.sessionCount>0||Number.isFinite(p.downloadCount)&&p.downloadCount>0)&&console.info("API gateway session download totals",{...g,sessionCount:p.sessionCount,downloadCount:p.downloadCount}),await K({sessionId:c,requestId:u,jobId:d,event:"lambda_http_response_summary",metadata:{...g,requestMetadata:E}})}return await K({sessionId:c,requestId:u,jobId:d,event:"lambda_invocation_succeeded",metadata:{invocationId:f,functionName:l,operationGroup:n,durationMs:w,coldStart:s}}),await ke({functionName:l,durationMs:w,success:!0,coldStart:s,operationGroup:n,httpSummary:p}),s=!1,h}catch(h){let w=Date.now()-S;if(console.error("Lambda invocation failed",{invocationId:f,functionName:l,requestId:u,sessionId:c,jobId:d,durationMs:w,operationGroup:n,coldStart:s,errorMessage:h?.message,errorCode:h?.code}),await K({sessionId:c,requestId:u,jobId:d,event:"lambda_invocation_failed",metadata:{invocationId:f,functionName:l,operationGroup:n,durationMs:w,coldStart:s,errorMessage:h?.message,errorCode:h?.code}}),await ke({functionName:l,durationMs:w,success:!1,coldStart:s,operationGroup:n,httpSummary:void 0}),(r||n&&["artifact-generation","artifact-download","enhancement"].includes(n))&&await Sn({error:h,requestId:u,sessionId:c,jobId:d,functionName:l,operationGroup:n,metadata:{invocationId:f,durationMs:w,requestMetadata:E},prefix:n==="artifact-generation"||n==="artifact-download"||n==="enhancement"?Wt:Ht}),s=!1,De(o))return En(h,{requestId:u});throw h}}}var te=Ee();function Tn(e=[]){let t=new Map(te.map((n,r)=>[n,r]));return[...e].sort((n,r)=>{let s=t.has(n.type)?t.get(n.type):te.length,i=t.has(r.type)?t.get(r.type):te.length;return s-i})}var An=async(e={})=>{let t=typeof e.resumeText=="string"?e.resumeText:"",n=Array.isArray(e.sectionResults)?e.sectionResults:[],r=Tn(n.filter(Boolean)),s=t,i=[];for(let o of r)!o||typeof o!="object"||(o.patch&&(s=be(s,o.patch)),i.push({type:o.type,title:o.title,explanation:o.explanation,beforeExcerpt:o.beforeExcerpt,afterExcerpt:o.afterExcerpt}));return{jobId:e.jobId||"",updatedResume:s,changeSummary:i}},Nn=Be(An,{name:"workflow-combine",operationGroup:"enhancement",captureErrorTrace:!0}),dr=Nn;export{dr as default,Nn as handler};
