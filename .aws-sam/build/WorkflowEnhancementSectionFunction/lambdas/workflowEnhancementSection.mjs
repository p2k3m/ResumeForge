import { createRequire as __createRequire } from 'module';
import { fileURLToPath as __fileURLToPath } from 'url';
import path from 'path';
const require = __createRequire(import.meta.url);
const __filename = __fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
globalThis.__filename = globalThis.__filename || __filename;
globalThis.__dirname = globalThis.__dirname || __dirname;
var ze=Object.create;var oe=Object.defineProperty;var Ke=Object.getOwnPropertyDescriptor;var qe=Object.getOwnPropertyNames;var He=Object.getPrototypeOf,We=Object.prototype.hasOwnProperty;var $=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var ie=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Ye=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of qe(t))!We.call(e,s)&&s!==n&&oe(e,s,{get:()=>t[s],enumerable:!(r=Ke(t,s))||r.enumerable});return e};var Ge=(e,t,n)=>(n=e!=null?ze(He(e)):{},Ye(t||!e||!e.__esModule?oe(n,"default",{value:e,enumerable:!0}):n,e));var ae=ie((Mn,Je)=>{Je.exports={name:"dotenv",version:"16.6.1",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=text --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},homepage:"https://github.com/motdotla/dotenv#readme",funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var fe=ie((Ln,R)=>{var Y=$("fs"),F=$("path"),Qe=$("os"),Xe=$("crypto"),Ze=ae(),G=Ze.version,et=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function tt(e){let t={},n=e.toString();n=n.replace(/\r\n?/mg,`
`);let r;for(;(r=et.exec(n))!=null;){let s=r[1],i=r[2]||"";i=i.trim();let o=i[0];i=i.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),o==='"'&&(i=i.replace(/\\n/g,`
`),i=i.replace(/\\r/g,"\r")),t[s]=i}return t}function nt(e){e=e||{};let t=de(e);e.path=t;let n=h.configDotenv(e);if(!n.parsed){let o=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw o.code="MISSING_DATA",o}let r=le(e).split(","),s=r.length,i;for(let o=0;o<s;o++)try{let c=r[o].trim(),d=st(n,c);i=h.decrypt(d.ciphertext,d.key);break}catch(c){if(o+1>=s)throw c}return h.parse(i)}function rt(e){console.log(`[dotenv@${G}][WARN] ${e}`)}function D(e){console.log(`[dotenv@${G}][DEBUG] ${e}`)}function ue(e){console.log(`[dotenv@${G}] ${e}`)}function le(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function st(e,t){let n;try{n=new URL(t)}catch(c){if(c.code==="ERR_INVALID_URL"){let d=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw d.code="INVALID_DOTENV_KEY",d}throw c}let r=n.password;if(!r){let c=new Error("INVALID_DOTENV_KEY: Missing key part");throw c.code="INVALID_DOTENV_KEY",c}let s=n.searchParams.get("environment");if(!s){let c=new Error("INVALID_DOTENV_KEY: Missing environment part");throw c.code="INVALID_DOTENV_KEY",c}let i=`DOTENV_VAULT_${s.toUpperCase()}`,o=e.parsed[i];if(!o){let c=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${i} in your .env.vault file.`);throw c.code="NOT_FOUND_DOTENV_ENVIRONMENT",c}return{ciphertext:o,key:r}}function de(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let n of e.path)Y.existsSync(n)&&(t=n.endsWith(".vault")?n:`${n}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=F.resolve(process.cwd(),".env.vault");return Y.existsSync(t)?t:null}function ce(e){return e[0]==="~"?F.join(Qe.homedir(),e.slice(1)):e}function ot(e){let t=!!(e&&e.debug),n=e&&"quiet"in e?e.quiet:!0;(t||!n)&&ue("Loading env from encrypted .env.vault");let r=h._parseVault(e),s=process.env;return e&&e.processEnv!=null&&(s=e.processEnv),h.populate(s,r,e),{parsed:r}}function it(e){let t=F.resolve(process.cwd(),".env"),n="utf8",r=!!(e&&e.debug),s=e&&"quiet"in e?e.quiet:!0;e&&e.encoding?n=e.encoding:r&&D("No encoding is specified. UTF-8 is used by default");let i=[t];if(e&&e.path)if(!Array.isArray(e.path))i=[ce(e.path)];else{i=[];for(let l of e.path)i.push(ce(l))}let o,c={};for(let l of i)try{let a=h.parse(Y.readFileSync(l,{encoding:n}));h.populate(c,a,e)}catch(a){r&&D(`Failed to load ${l} ${a.message}`),o=a}let d=process.env;if(e&&e.processEnv!=null&&(d=e.processEnv),h.populate(d,c,e),r||!s){let l=Object.keys(c).length,a=[];for(let u of i)try{let f=F.relative(process.cwd(),u);a.push(f)}catch(f){r&&D(`Failed to load ${u} ${f.message}`),o=f}ue(`injecting env (${l}) from ${a.join(",")}`)}return o?{parsed:c,error:o}:{parsed:c}}function at(e){if(le(e).length===0)return h.configDotenv(e);let t=de(e);return t?h._configVault(e):(rt(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),h.configDotenv(e))}function ct(e,t){let n=Buffer.from(t.slice(-64),"hex"),r=Buffer.from(e,"base64"),s=r.subarray(0,12),i=r.subarray(-16);r=r.subarray(12,-16);try{let o=Xe.createDecipheriv("aes-256-gcm",n,s);return o.setAuthTag(i),`${o.update(r)}${o.final()}`}catch(o){let c=o instanceof RangeError,d=o.message==="Invalid key length",l=o.message==="Unsupported state or unable to authenticate data";if(c||d){let a=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw a.code="INVALID_DOTENV_KEY",a}else if(l){let a=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw a.code="DECRYPTION_FAILED",a}else throw o}}function ut(e,t,n={}){let r=!!(n&&n.debug),s=!!(n&&n.override);if(typeof t!="object"){let i=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw i.code="OBJECT_REQUIRED",i}for(let i of Object.keys(t))Object.prototype.hasOwnProperty.call(e,i)?(s===!0&&(e[i]=t[i]),r&&D(s===!0?`"${i}" is already defined and WAS overwritten`:`"${i}" is already defined and was NOT overwritten`)):e[i]=t[i]}var h={configDotenv:it,_configVault:ot,_parseVault:nt,config:at,decrypt:ct,parse:tt,populate:ut};R.exports.configDotenv=h.configDotenv;R.exports._configVault=h._configVault;R.exports._parseVault=h._parseVault;R.exports.config=h.config;R.exports.decrypt=h.decrypt;R.exports.parse=h.parse;R.exports.populate=h.populate;R.exports=h});var ye=Ge(fe(),1);import mt from"fs";import ht from"path";import A from"process";import w from"node:process";function E(e){return typeof e=="string"&&e.trim().length>0}function x(e){return typeof e=="string"?e.trim():""}var pe=new Map(Object.entries({development:"dev",dev:"dev",production:"prod",prod:"prod",staging:"stage",stage:"stage",testing:"test",test:"test"}));function k(e){let t=x(e).toLowerCase();return t?pe.has(t)?pe.get(t):t:""}function lt(){let e=x(w.env.NODE_ENV);return k(e)}function me(){if(E(w.env.STAGE_NAME)){let t=k(w.env.STAGE_NAME);if(t)return t}if(E(w.env.DEPLOYMENT_ENVIRONMENT)){let t=k(w.env.DEPLOYMENT_ENVIRONMENT);if(t)return t}let e=lt();return e||"dev"}function dt({stageName:e}={}){if(E(w.env.DEPLOYMENT_ENVIRONMENT)){let n=k(w.env.DEPLOYMENT_ENVIRONMENT);if(n)return n}let t=E(e)?k(e):me();return t||"dev"}function he(){return E(w.env.DATA_BUCKET)?x(w.env.DATA_BUCKET):E(w.env.S3_BUCKET)?x(w.env.S3_BUCKET):""}function ft({dataBucket:e}={}){if(E(w.env.STATIC_ASSETS_BUCKET))return x(w.env.STATIC_ASSETS_BUCKET);if(E(e))return x(e);let t=he();return t||""}function pt(){return E(w.env.LOGS_BUCKET)?x(w.env.LOGS_BUCKET):""}function N(e,t){typeof e=="string"&&E(t)&&(w.env[e]=x(t))}function ge({propagateToProcessEnv:e=!0,propagateViteEnv:t=!1}={}){let n=me(),r=dt({stageName:n}),s=he(),i=ft({dataBucket:s}),o=pt();return e&&(N("STAGE_NAME",n),N("DEPLOYMENT_ENVIRONMENT",r),E(s)&&N("S3_BUCKET",s),E(i)&&N("STATIC_ASSETS_BUCKET",i),E(o)&&N("LOGS_BUCKET",o)),t&&(N("VITE_STAGE_NAME",n),N("VITE_DEPLOYMENT_ENVIRONMENT",r),E(s)&&(N("VITE_S3_BUCKET",s),N("VITE_DATA_BUCKET",s)),E(i)&&N("VITE_STATIC_ASSETS_BUCKET",i),E(o)&&N("VITE_LOGS_BUCKET",o)),{stageName:n,deploymentEnvironment:r,dataBucket:s,staticAssetsBucket:i,logsBucket:o}}function _(e){return typeof e=="string"&&e.trim().length>0}var gt=_(A.env.NODE_ENV)?A.env.NODE_ENV.trim().toLowerCase():"development",yt=!!A.env.AWS_LAMBDA_FUNCTION_NAME,bt=!yt&&(gt==="development"||!_(A.env.NODE_ENV));if(bt){let e=ht.resolve(A.cwd(),".env");mt.existsSync(e)&&ye.default.config({path:e})}var be=["S3_BUCKET","GEMINI_API_KEY"],Et=["CLOUDFRONT_ORIGINS"],J=be.filter(e=>!_(A.env[e]));Et.forEach(e=>{_(A.env[e])||console.warn(`Optional environment value ${e} is not set. Provide it via the runtime config file or environment to enable strict CORS.`)});!_(A.env.AWS_REGION)&&_(A.env.AWS_DEFAULT_REGION)&&(A.env.AWS_REGION=A.env.AWS_DEFAULT_REGION.trim());_(A.env.AWS_REGION)||J.push("AWS_REGION");if(J.length>0)throw new Error(`Missing required environment variables: ${J.join(", ")}. Ensure they are configured via deployment secrets or a local .env file.`);var{stageName:Un,deploymentEnvironment:wt}=ge({propagateToProcessEnv:!0,propagateViteEnv:!1});function St(e){let t=new URLSearchParams(e||"");return t.set("environment",wt),t.toString()}function j(e={}){return{...e,Tagging:St(e.Tagging)}}var $n=Object.freeze([...be,"AWS_REGION"]);var Pn=new Set("a,an,and,are,as,at,be,by,for,from,has,have,in,is,it,of,on,or,that,the,to,with,will,our,your,they,them,into,about,over,more,than,who,what,when,where,which,were,while,within,under,across,through,using,per".split(",").map(e=>e.trim()));function Ee(e){let t=[],n=i=>{if(i!=null){if(Array.isArray(i)){i.forEach(o=>n(o));return}if(typeof i=="object"){Object.values(i).forEach(o=>n(o));return}typeof i=="string"&&i.split(/[\n,]/).map(o=>o.trim()).filter(Boolean).forEach(o=>t.push(o))}};n(e);let r=new Set,s=[];for(let i of t){let o=i.toLowerCase();r.has(o)||(r.add(o),s.push(i))}return s}var T={summary:["summary","professional summary","profile"],skills:["skills","key skills","core skills"],experience:["experience","work experience","professional experience"],certifications:["certifications","licenses"],projects:["projects","key projects"],highlights:["highlights","key highlights","career highlights"]};function Q(e){return typeof e=="string"?e.replace(/\s+/g," ").trim():""}function we(e){return Array.isArray(e)?e.map(t=>String(t||"")).join(`
`):typeof e!="string"?"":e}function C(e){return e?Array.isArray(e)?e.map(t=>String(t||"")):String(e||"").replace(/\r/g,"").split(`
`):[]}function M(e){return Q(e).replace(/:$/,"").toLowerCase()}function At(e,t){if(!Array.isArray(e)||!e.length)return{index:-1,matchedLabel:""};let n=t.map(r=>M(r));for(let r=0;r<e.length;r+=1){let s=M(e[r]);if(s&&n.includes(s))return{index:r,matchedLabel:e[r]}}return{index:-1,matchedLabel:""}}function X(e,t){let{index:n}=At(e,t);if(n===-1)return{start:-1,end:-1};let r=e.length;for(let s=n+1;s<e.length;s+=1){let i=M(e[s]);if(!i){r=s;break}if(Object.values(T).some(c=>c.some(d=>M(d)===i))){r=s;break}}return{start:n,end:r}}function Tt(e,t,n){let r=C(e),{start:s,end:i}=X(r,t),o=Array.isArray(n)?n:C(n);if(s===-1){let d=t[0]?t[0].toUpperCase():"SUMMARY",l=[...r];return l.length&&l[l.length-1].trim()&&l.push(""),l.push(d.toUpperCase()),l.push(...o),l.join(`
`)}let c=[...r];return c.splice(s,Math.max(i-s,1),r[s],...o),c.join(`
`)}function Nt(e,t){let n=C(e);if(!n.length)return t||"";let r=[...n];return r[0]=t?t.toUpperCase():n[0],r.join(`
`)}function B(e,t,n){let r=C(e),s=Array.isArray(n)?n:C(n),{start:i}=X(r,t),o=[...r];if(i===-1){let a=t[0]?t[0].toUpperCase():"SECTION";return o.length&&o[o.length-1].trim()&&o.push(""),o.push(a.toUpperCase()),o.push(...s),o.join(`
`)}let c=new Set;for(let a=i+1;a<o.length;a+=1){let u=M(o[a]);if(!u)break;c.add(u)}let d=i+1,l=s.filter(a=>{let u=M(a);return!u||c.has(u)?!1:(c.add(u),!0)});return l.length?(o.splice(d,0,...l),o.join(`
`)):e}function Ct(e="",t=[]){let n=Q(e);if(!n)return t.length?`Seasoned professional aligning ${t.join(", ")} impact with hiring needs.`:"Results-driven professional aligning experience with key hiring priorities.";let r=n.split(/[.!?]+/).map(i=>i.trim()).filter(Boolean);if(!r.length)return n;let s=r.slice(0,2).join(". ");return t.length?`${s}. Demonstrates strengths across ${t.slice(0,5).join(", ")}.`:`${s}.`}function vt(e=[]){return e.length?e.slice(0,10).map(t=>`\u2022 ${t}`):[]}function Rt(e="",t=[]){let n=t.slice(0,3).join(", ");return[`\u2022 Reframed accomplishments to spotlight ${n?`key responsibilities across ${n}`:"key responsibilities from the job description"}.`,"\u2022 Quantified impact to mirror recruiter expectations from the job description."]}function It(e=[]){return e.length?[`\u2022 Added a featured project demonstrating ${e.slice(0,2).join(" and ")} with measurable results.`]:["\u2022 Highlighted a recent project with measurable outcomes tied to business goals."]}function xt(e=[]){return["\u2022 Surfaced two accomplishment bullets that communicate speed-to-impact.",...e.length?[`\u2022 Brought ${e[0]} wins to the top of the page for quick scanning.`]:[]]}function _t(e=[],t=[]){return e.length?e.map(n=>`\u2022 ${n}`):t.length?[`\u2022 Recommended certification paths to reinforce ${t[0]} credibility.`]:["\u2022 Suggested certifications that reinforce credibility for the target role."]}function Se(e){return Array.isArray(e)?e:typeof e=="string"?e.split(/[,\n;]/).map(t=>t.trim()).filter(Boolean):[]}function Ae(e={}){let t=e.type||"improve-summary",n=we(e.resumeText||""),r=we(e.jobDescription||""),s=Ee(e.jobSkills),i=Se(e.missingSkills),o=Q(e.targetTitle||e.jobTitle),c=Se(e.manualCertificates),d={"improve-summary":()=>{let a=T.summary,u=X(C(n),a),y=(u.start===-1?[]:C(n).slice(u.start+1,Math.max(u.end,u.start+1))).join(`
`),S=o?`${o.toUpperCase()}`:C(n)[0]||"",m=[Ct(r,s)],p=Tt(n,a,m);return{type:t,title:"Rewrite summary",explanation:"Focused the opening summary on the target role and key hiring themes.",beforeExcerpt:y,afterExcerpt:m.join(`
`),patch:{op:"replace-section",sectionLabels:a,lines:m},updatedResume:p}},"add-missing-skills":()=>{let a=i.length?i:s,u=vt(a),f=B(n,T.skills,u);return{type:t,title:"Add missing skills",explanation:"Appended skills directly sourced from the job description.",beforeExcerpt:"",afterExcerpt:u.join(`
`),patch:{op:"append-unique-lines",sectionLabels:T.skills,lines:u},updatedResume:f}},"change-designation":()=>{if(!o)return{type:t,title:"Align designation",explanation:"No target title supplied; skipped designation alignment.",beforeExcerpt:C(n)[0]||"",afterExcerpt:C(n)[0]||"",patch:null,updatedResume:n};let a=C(n)[0]||"",u=Nt(n,o);return{type:t,title:"Align designation",explanation:"Updated the visible designation to match the target job title.",beforeExcerpt:a,afterExcerpt:o.toUpperCase(),patch:{op:"replace-first-line",value:o},updatedResume:u}},"align-experience":()=>{let a=Rt(r,s),u=B(n,T.experience,a);return{type:t,title:"Align experience",explanation:"Inserted measurable accomplishments that mirror the JD expectations.",beforeExcerpt:"",afterExcerpt:a.join(`
`),patch:{op:"append-unique-lines",sectionLabels:T.experience,lines:a},updatedResume:u}},"improve-certifications":()=>{let a=_t(c,s),u=B(n,T.certifications,a);return{type:t,title:"Improve certifications",explanation:"Suggested certifications to reinforce credibility.",beforeExcerpt:"",afterExcerpt:a.join(`
`),patch:{op:"append-unique-lines",sectionLabels:T.certifications,lines:a},updatedResume:u}},"improve-projects":()=>{let a=It(s),u=B(n,T.projects,a);return{type:t,title:"Improve projects",explanation:"Highlighted projects that echo the job description.",beforeExcerpt:"",afterExcerpt:a.join(`
`),patch:{op:"append-unique-lines",sectionLabels:T.projects,lines:a},updatedResume:u}},"improve-highlights":()=>{let a=xt(s),u=B(n,T.highlights,a);return{type:t,title:"Improve highlights",explanation:"Surfaced quick-scan achievements for recruiters.",beforeExcerpt:"",afterExcerpt:a.join(`
`),patch:{op:"append-unique-lines",sectionLabels:T.highlights,lines:a},updatedResume:u}}};return(d[t]||d["improve-summary"])()}import{CloudWatchClient as Gt,PutMetricDataCommand as re}from"@aws-sdk/client-cloudwatch";import{S3Client as Jt}from"@aws-sdk/client-s3";import{randomUUID as Ue}from"crypto";import{GetObjectCommand as qt,PutObjectCommand as Me}from"@aws-sdk/client-s3";var Te=new Set(["ECONNRESET","ECONNREFUSED","ETIMEDOUT","EPIPE","EAI_AGAIN","ENOTFOUND","ECONNABORTED","ENETUNREACH","EHOSTUNREACH"]),Ne=new Set(["SLOWDOWN","SLOWDOWNERROR","REQUESTTIMEOUT","THROTTLING","THROTTLINGEXCEPTION","SERVICEUNAVAILABLE","INTERNALERROR"]);function Mt(e){return new Promise(t=>setTimeout(t,e))}function P(e){if(!(!e||typeof e!="object")){if(typeof e.status=="number")return e.status;if(typeof e.statusCode=="number")return e.statusCode;if(typeof e.$metadata?.httpStatusCode=="number")return e.$metadata.httpStatusCode;if(typeof e.response?.status=="number")return e.response.status;if(typeof e.cause?.status=="number")return e.cause.status;if(typeof e.cause?.statusCode=="number")return e.cause.statusCode}}function Lt(e){return Number.isFinite(e)?e===429||e>=500:!1}function Ot(e){if(!e||typeof e!="object")return!1;let t=typeof e.code=="string"?e.code.toUpperCase():"";if(t&&Te.has(t))return!0;let n=typeof e.name=="string"?e.name.toUpperCase():"";if(n&&Te.has(n))return!0;let r=typeof e.message=="string"?e.message.toLowerCase():"";return r?r.includes("timed out")||r.includes("timeout")||r.includes("temporarily unavailable")||r.includes("connection reset")||r.includes("socket hang up"):!1}function Z(e){if(!e||typeof e!="object")return!1;let t=P(e);if(Lt(t)||Ot(e))return!0;let n=typeof e.code=="string"?e.code.toUpperCase():"";if(n&&Ne.has(n))return!0;let r=typeof e.name=="string"?e.name.toUpperCase():"";return!!(r&&Ne.has(r))}async function ee(e,t={}){let{maxAttempts:n=3,baseDelayMs:r=500,maxDelayMs:s=5e3,jitterMs:i=250,shouldRetry:o=()=>!1,onRetry:c}=t,d;for(let l=1;l<=n;l+=1)try{return await e(l)}catch(a){if(d=a,!(l<n&&o(a,l)))throw a;let f=r*2**(l-1),y=Math.min(s,f),S=i>0?Math.floor(Math.random()*i):0,g=Math.max(0,y+S);if(typeof c=="function")try{c(a,l,g)}catch{}await Mt(g)}throw d}import{randomBytes as Ht,randomUUID as Ie}from"crypto";import I from"node:process";var z=null;function Ce(e=[]){for(let t of e)if(typeof t=="string"){let n=t.trim();if(n)return n}return null}function Dt(e){if(!e)return null;let t=new Date(e);return Number.isNaN(t.getTime())?null:t.toISOString()}function kt(){let e=[I.env.BUILD_TIMESTAMP,I.env.DEPLOY_TIMESTAMP];for(let t of e){let n=Dt(t);if(n)return n}return new Date().toISOString()}function jt(){if(z)return z;let e=Ce([I.env.BUILD_VERSION,I.env.VERSION,I.env.npm_package_version]),t=Ce([I.env.BUILD_SHA,I.env.GIT_COMMIT,I.env.GIT_SHA,I.env.GITHUB_SHA]),n=kt();return z={version:e||null,sha:t||null,timestamp:n},z}function te(e,{fallback:t="unknown"}={}){return typeof e=="string"&&e.trim()?e.trim():typeof e=="number"&&Number.isFinite(e)?String(e):t}function ve({versionLabel:e}={}){let{version:t,sha:n,timestamp:r}=jt(),s={"build-timestamp":te(r,{fallback:new Date().toISOString()}),"build-version":te(t||e),"build-sha":te(n)};return typeof e=="string"&&e.trim()&&(s["asset-version-label"]=e.trim()),s}function Bt(e={}){let t=ve(e),n=typeof t["build-sha"]=="string"?t["build-sha"].trim():"",r=typeof t["build-timestamp"]=="string"?t["build-timestamp"].trim():"",s=[];return n&&s.push({Key:"build",Value:n}),r&&s.push({Key:"deployed",Value:r}),s}function Vt(e,t=[]){let n=new URLSearchParams(e||"");for(let r of t){if(!r||typeof r.Key!="string")continue;let s=r.Key.trim();if(!s)continue;let i=typeof r.Value=="string"?r.Value.trim():"";i&&n.set(s,i)}return n.toString()}function ne(e={},t={}){let n=ve(t),r=e&&typeof e=="object"&&typeof e.Metadata=="object"&&e.Metadata!==null&&!Array.isArray(e.Metadata)?e.Metadata:{},s=Vt(e?.Tagging,Bt(t)),i={...e,Metadata:{...r,...n}};return s&&(i.Tagging=s),i}function v(e){return e==null?"":typeof e=="string"?e.trim():typeof e=="number"||typeof e=="bigint"?String(e):""}function V(...e){for(let t of e){let n=v(t);if(n)return n}return""}function Ut(){return V(process.env.RESUMEFORGE_BUILD_ID,process.env.BUILD_ID,process.env.DEPLOYMENT_BUILD_ID,process.env.GITHUB_RUN_ID,process.env.GITHUB_SHA,process.env.AWS_LAMBDA_FUNCTION_VERSION)||"local-dev"}var $t=Ut();function Ft(e={}){return V(e.build,e.buildId,e.metadata?.build,e.metadata?.buildId)||$t}function Pt(e={}){let t=n=>Array.isArray(n)&&n.length?n[0]:"";return V(e.template,e.templateId,e.resumeTemplate,e.coverTemplate,e.preferredTemplate,e.canonicalSelectedTemplate,e.selectedTemplate,e.template1,e.template2,t(e.templates),t(e.availableCvTemplates),e.coverTemplate1,e.coverTemplate2)||"unknown"}function zt(e={}){return V(e.session,e.sessionId,e.jobId,e.requestId,e.detail?.sessionId,e.detail?.jobId,e.metadata?.session,e.metadata?.sessionId)||"unknown"}function Kt(e={}){let t=Array.isArray(e.urls)?e.urls:[],n=t.length>0?v(t[0]?.type):"",r=()=>{let s=v(e.event);return s?s.includes("cover_letter")?"cover_letter":s.includes("generation_artifacts")?"generated_artifact":s.includes("initial_upload")?"upload_artifact":"":""};return V(e.artifactType,e.metadata?.artifactType,e.type,e.cleanupEvent,n,r())||"none"}function K(e={},t={},n={}){let{embedMetadata:r=!0}=n;if(!e||typeof e!="object")return e;let s={...typeof e.metadata=="object"&&e.metadata?e.metadata:{},...typeof t.metadata=="object"&&t.metadata?t.metadata:{}},i={...s,...e,...t},o=Pt(i),c=zt(i),d=Ft({...i,metadata:s}),l=Kt(i),a={...e};v(a.template)||(a.template=o),v(a.session)||(a.session=c),v(a.build)||(a.build=d),v(a.artifactType)||(a.artifactType=l);let u={...s};return v(u.template)||(u.template=o),v(u.session)||(u.session=c),v(u.build)||(u.build=d),v(u.artifactType)||(u.artifactType=l),r?(Object.keys(u).length>0&&(a.metadata=u),a):u}function Re(e={},t={}){let n=K(e,t,{embedMetadata:!1});return!n||typeof n!="object"?{}:n}async function Wt(e){return await new Promise((t,n)=>{let r=[];e.on("data",s=>r.push(s)),e.on("error",n),e.on("end",()=>t(Buffer.concat(r).toString("utf-8")))})}async function Le({s3:e,bucket:t,key:n,jobId:r,event:s,level:i="info",message:o,metadata:c,template:d,session:l,build:a,artifactType:u}){let f={jobId:r,template:d,session:l,build:a,artifactType:u},y=c&&typeof c=="object"&&!Array.isArray(c)?c:{},S=Re(y,f),g=K({timestamp:new Date().toISOString(),jobId:r,event:s,level:i,...o?{message:o}:{},metadata:S},f),m="";try{let b=await e.send(new qt({Bucket:t,Key:n}));m=await Wt(b.Body)}catch(b){if(b.name!=="NoSuchKey"&&b.$metadata?.httpStatusCode!==404)throw b}let p=m+JSON.stringify(g)+`
`;await ee(()=>e.send(new Me(j(ne({Bucket:t,Key:n,Body:p,ContentType:"application/json"})))),{maxAttempts:4,baseDelayMs:500,maxDelayMs:4e3,jitterMs:300,shouldRetry:b=>Z(b),onRetry:(b,Fe,Pe)=>{console.warn("Retrying S3 log upload",{bucket:t,key:n,attempt:Fe,delayMs:Pe,status:P(b),code:b?.code})}})}function xe(){if(typeof Ie=="function")try{return Ie()}catch{}return Ht(16).toString("hex")}function _e(e){return e?String(e).trim().replace(/[^a-zA-Z0-9._-]+/g,"-").replace(/^-+|-+$/g,"").slice(0,80):""}function Yt(e=""){if(!e)return"";let t=e.replace(/^\/+/,"").replace(/\/+/g,"/");return t.endsWith("/")?t:`${t}/`}async function Oe({s3:e,bucket:t,entry:n,prefix:r="logs/errors/",key:s}){if(!e||!t||!n)return;let i=typeof n?.timestamp=="string"&&n.timestamp.trim()?n.timestamp:new Date().toISOString(),o=i.slice(0,10),c=_e(n.requestId)||xe(),d=_e(i)||xe(),l=Yt(r),a=typeof s=="string"&&s.trim()?s.trim():`${l}${o}/${d}-${c}.json`,u=K({...n,timestamp:i},{jobId:n?.jobId,template:n?.template,session:n?.session,build:n?.build,artifactType:n?.artifactType,metadata:n?.metadata});await ee(()=>e.send(new Me(j(ne({Bucket:t,Key:a,Body:JSON.stringify(u),ContentType:"application/json"})))),{maxAttempts:4,baseDelayMs:500,maxDelayMs:4e3,jitterMs:300,shouldRetry:f=>Z(f),onRetry:(f,y,S)=>{console.warn("Retrying S3 trace upload",{bucket:t,key:s,attempt:y,delayMs:S,status:P(f),code:f?.code})}})}var U=process.env.AWS_REGION||process.env.AWS_DEFAULT_REGION||void 0,q=U?new Gt({region:U}):null,W=U?new Jt({region:U}):null,De=process.env.METRICS_NAMESPACE||"ResumeForge/Operations",Qt=process.env.ARTIFACT_METRICS_NAMESPACE||"ResumeForge/Artifacts",se=process.env.SESSION_CHANGE_LOG_PREFIX||"logs/sessions/",Xt=process.env.LAMBDA_ERROR_TRACE_PREFIX||"logs/errors/",Zt=process.env.ARTIFACT_FAILURE_LOG_PREFIX||"logs/artifact-failures/",O=process.env.LOGS_BUCKET||process.env.S3_BUCKET||"",L=process.env.STAGE_NAME||process.env.DEPLOYMENT_ENVIRONMENT||"prod",en=/^\/(?:assets|fonts|images|cover-templates)(?:\b|\/)/i,ke=Object.freeze({"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Headers":"Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token","Access-Control-Allow-Methods":"OPTIONS,GET,POST"}),tn="An unexpected error occurred. Please try again later.",nn="The request could not be completed.";function rn(e={},t={}){return e?.requestContext?.requestId||e?.headers?.["x-amzn-requestid"]||e?.headers?.["x-amzn-request-id"]||t?.awsRequestId||Ue()}function sn(e={}){if(!e||typeof e!="object")return"";if(typeof e.sessionId=="string"&&e.sessionId.trim())return e.sessionId.trim();if(typeof e.jobId=="string"&&e.jobId.trim())return e.jobId.trim();if(typeof e.detail=="object"&&e.detail){let t=e.detail;if(typeof t.sessionId=="string"&&t.sessionId.trim())return t.sessionId.trim();if(typeof t.jobId=="string"&&t.jobId.trim())return t.jobId.trim()}if(Array.isArray(e.Records)&&e.Records.length>0){let t=e.Records[0];if(t&&typeof t.body=="string")try{let n=JSON.parse(t.body);if(n&&typeof n=="object"){if(typeof n.sessionId=="string"&&n.sessionId.trim())return n.sessionId.trim();if(typeof n.jobId=="string"&&n.jobId.trim())return n.jobId.trim();if(n.payload&&typeof n.payload=="object"&&typeof n.payload.jobId=="string"&&n.payload.jobId.trim())return n.payload.jobId.trim()}}catch{}}return""}function on(e=""){return String(e).trim().replace(/[^a-zA-Z0-9._-]+/g,"-").replace(/^-+|-+$/g,"").slice(0,120)}function an(e,t){let n=e||t;if(!n)return"";let r=on(n);return`${se.endsWith("/")?se:`${se}/`}${r}.jsonl`}function cn(e={}){return e?.requestContext?.http?{type:"http",method:e.requestContext.http.method,path:e.requestContext.http.path,protocol:e.requestContext.http.protocol,sourceIp:e.requestContext.http.sourceIp,userAgent:e.requestContext.http.userAgent}:typeof e.httpMethod=="string"&&typeof e.path=="string"?{type:"http-legacy",method:e.httpMethod,path:e.path}:Array.isArray(e.Records)?{type:"records",recordCount:e.Records.length,sources:Array.from(new Set(e.Records.map(t=>t.eventSource||t.EventSource||t.source).filter(Boolean)))}:e?.detailType||e?.source?{type:"event-bridge",detailType:e.detailType,source:e.source}:e?.source==="aws.states"?{type:"step-functions"}:{type:typeof e}}function un(e){if(!e||typeof e!="object")return{};let t={};for(let[n,r]of Object.entries(e))typeof n=="string"&&(t[n.toLowerCase()]=r);return t}function je(e){if(typeof e!="string")return null;let t=e.trim();if(!t||!t.startsWith("{")&&!t.startsWith("["))return null;try{return JSON.parse(t)}catch{return null}}function ln(e){return e&&Array.isArray(e)?e.filter(t=>t!=null).length:0}function dn(e){if(!e||typeof e!="object")return 0;let t=[e.sessionCount,e.totalSessions,e.sessions?.length,e.sessionLogs?.length].filter(r=>Number.isFinite(r)&&r>0),n=t.length?Math.max(...t.map(r=>Number(r))):0;return typeof e.sessionId=="string"&&e.sessionId.trim()&&(n=Math.max(n,1)),Array.isArray(e.sessionIds)&&(n=Math.max(n,e.sessionIds.length)),Array.isArray(e.sessions)&&(n=Math.max(n,e.sessions.length)),Array.isArray(e.sessionLogs)&&(n=Math.max(n,e.sessionLogs.length)),n}var fn=["urls","downloads","downloadUrls","download_logs","downloadLogs","files","artifacts","links"],pn=["downloadCount","totalDownloads","downloadTotal"];function mn(e){if(!e||typeof e!="object")return 0;let t=0;for(let n of pn){let r=e[n];Number.isFinite(r)&&r>0&&(t=Math.max(t,Number(r)))}for(let n of fn)Array.isArray(e[n])&&(t=Math.max(t,ln(e[n])));return t}function hn(e={},t={}){return typeof t?.path=="string"&&t.path?t.path:typeof e?.rawPath=="string"&&e.rawPath?e.rawPath:typeof e?.path=="string"&&e.path?e.path:typeof e?.requestContext?.http?.path=="string"?e.requestContext.http.path:""}function gn(e={},t={}){return typeof t?.method=="string"&&t.method?t.method:typeof e?.requestContext?.http?.method=="string"?e.requestContext.http.method:typeof e?.httpMethod=="string"?e.httpMethod:""}function yn(e=""){if(typeof e!="string"||!e)return"unknown";if(e==="/"||e==="")return"root";if(e.startsWith("/api/")){let[,,t]=e.split("/",3);return t?`/api/${t}`:"/api"}return e.startsWith("/assets")?"/assets":e.startsWith("/fonts")?"/fonts":e.startsWith("/images")?"/images":e.startsWith("/cover-templates")?"/cover-templates":e.split("?")[0]||"unknown"}function bn(e,{event:t,requestMetadata:n,durationMs:r}={}){if(!e||typeof e!="object")return null;let s=un(e.headers),i=Number.isInteger(e.statusCode)?Number(e.statusCode):void 0,o=gn(t,n),c=hn(t,n),d=s["content-length"],l=d!==void 0?Number(d):!e.isBase64Encoded&&typeof e.body=="string"?Buffer.byteLength(e.body):void 0,a=null,u=s["content-type"],f=typeof u=="string"&&/json/i.test(u);!e.isBase64Encoded&&typeof e.body=="string"&&e.body&&(a=je(e.body));let y=dn(a),S=mn(a),g=yn(c),m=en.test(c);return{statusCode:i,method:o,path:c,pathCategory:g,contentLength:Number.isFinite(l)?l:void 0,sessionCount:Number.isFinite(y)&&y>0?y:0,downloadCount:Number.isFinite(S)&&S>0?S:0,isAssetRequest:m,durationMs:Number.isFinite(r)?r:void 0}}function En(e={}){return!e||typeof e!="object"?{}:Object.fromEntries(Object.entries(e).filter(([,t])=>t!=null))}function Be(e={}){return!e||typeof e!="object"?!1:!!(typeof e.httpMethod=="string"||e?.requestContext?.http&&typeof e.requestContext.http.method=="string"||typeof e.version=="string"&&e.version.startsWith("2")&&(typeof e.rawPath=="string"||typeof e.routeKey=="string")||typeof e.rawPath=="string"&&typeof e.requestContext=="object"||typeof e.resource=="string"&&typeof e.path=="string")}function wn(e){return[e?.statusCode,e?.status,e?.httpStatus,e?.response?.status,e?.output?.statusCode].find(r=>Number.isInteger(r)&&r>=400&&r<=599)??500}function Sn(e,t){return typeof e?.code=="string"&&e.code.trim()?e.code.trim():t>=500?"INTERNAL_SERVER_ERROR":"BAD_REQUEST"}function An(e,t){return typeof e?.message=="string"&&e.message.trim()?e.message.trim():t>=500?tn:nn}function Tn(e){if(e?.details!==void 0)return e.details;if(e?.errors!==void 0)return e.errors;if(e?.data!==void 0)return e.data;if(e?.response?.data!==void 0)return e.response.data}function Nn(e){return!e||typeof e!="object"?{...ke}:{...ke,...e}}function Cn(e,{requestId:t}={}){let n=wn(e),r=Sn(e,n),s=An(e,n),i=Tn(e),o={success:!1,code:r,message:s,...i!==void 0?{details:i}:{},...t?{requestId:t}:{}},c;if(typeof e?.body=="string")c=e.body;else if(e?.body&&typeof e.body=="object")try{c=JSON.stringify(e.body)}catch{c=JSON.stringify(o)}else c=JSON.stringify(o);return{statusCode:n,headers:Nn(e?.headers),body:c,isBase64Encoded:!!(e?.isBase64Encoded&&c===e?.body)}}function vn(e,t,n){if(!e)return[];let r=(i={})=>{let o=t.map(c=>({...c}));e.pathCategory&&o.push({Name:"Path",Value:e.pathCategory}),e.method&&o.push({Name:"Method",Value:e.method}),e.isAssetRequest&&o.push({Name:"AssetRequest",Value:"true"});for(let[c,d]of Object.entries(i))typeof c=="string"&&typeof d=="string"&&o.push({Name:c,Value:d});return o},s=[];return e.isAssetRequest&&Number.isFinite(e.durationMs)&&s.push({MetricName:"AssetResponseDuration",Dimensions:r(),Timestamp:n,Unit:"Milliseconds",Value:e.durationMs}),e.statusCode===404&&s.push({MetricName:"HttpNotFound",Dimensions:r(),Timestamp:n,Unit:"Count",Value:1}),Number.isFinite(e.sessionCount)&&e.sessionCount>0&&s.push({MetricName:"SessionCount",Dimensions:r({Detail:"Sessions"}),Timestamp:n,Unit:"Count",Value:e.sessionCount}),Number.isFinite(e.downloadCount)&&e.downloadCount>0&&s.push({MetricName:"DownloadCount",Dimensions:r({Detail:"Downloads"}),Timestamp:n,Unit:"Count",Value:e.downloadCount}),s}async function Ve({functionName:e,durationMs:t,success:n,coldStart:r,operationGroup:s,httpSummary:i}){if(!q||!U)return;let o=new Date,c=[{Name:"FunctionName",Value:e},{Name:"Stage",Value:L}];s&&c.push({Name:"Operation",Value:s});let d=[{MetricName:"InvocationDuration",Dimensions:c,Timestamp:o,Unit:"Milliseconds",Value:t},{MetricName:"InvocationCount",Dimensions:[...c,{Name:"Status",Value:n?"Success":"Failure"}],Timestamp:o,Unit:"Count",Value:1}];r&&d.push({MetricName:"ColdStart",Dimensions:c,Timestamp:o,Unit:"Count",Value:1});try{await q.send(new re({Namespace:De,MetricData:d}))}catch(f){console.warn("Failed to publish lambda metrics",{functionName:e,stage:L,errorMessage:f?.message})}let l=vn(i,c,o);if(l.length)try{await q.send(new re({Namespace:De,MetricData:l}))}catch(f){console.warn("Failed to publish HTTP summary metrics",{functionName:e,stage:L,errorMessage:f?.message})}if(!s)return;let a=n?"Success":"Failure",u=[{MetricName:`${s.replace(/-/g," ").replace(/\s+/g,"")}${a}`,Dimensions:[{Name:"Operation",Value:s},{Name:"Stage",Value:L}],Timestamp:o,Unit:"Count",Value:1}];try{await q.send(new re({Namespace:Qt,MetricData:u}))}catch(f){console.warn("Failed to publish artifact metrics",{operationGroup:s,stage:L,errorMessage:f?.message})}}async function H({sessionId:e,requestId:t,jobId:n,event:r,metadata:s}){if(!W||!O)return;let i=an(e,t);if(i)try{await Le({s3:W,bucket:O,key:i,jobId:n||e||t,event:r,metadata:j({...s,stage:L})})}catch(o){console.warn("Failed to append session change log",{key:i,bucket:O,event:r,errorMessage:o?.message})}}async function Rn({error:e,requestId:t,sessionId:n,jobId:r,functionName:s,operationGroup:i,metadata:o,prefix:c}){if(!W||!O||!e)return;let d={requestId:t,sessionId:n,jobId:r,functionName:s,operationGroup:i,message:e.message,stack:e.stack,metadata:o};try{await Oe({s3:W,bucket:O,entry:d,prefix:c})}catch(l){console.warn("Failed to upload lambda error trace",{functionName:s,bucket:O,errorMessage:l?.message})}}function $e(e,{name:t="lambda-function",operationGroup:n,captureErrorTrace:r=!1}={}){if(typeof e!="function")throw new TypeError("withLambdaObservability expects a handler function.");let s=!0;return async function(o,c){let d=c?.functionName||t,l=rn(o,c),a=sn(o),u=typeof o?.jobId=="string"?o.jobId:"",f=Ue(),y=cn(o);console.info("Lambda invocation started",{invocationId:f,functionName:d,requestId:l,sessionId:a,jobId:u,coldStart:s,operationGroup:n,requestMetadata:y}),await H({sessionId:a,requestId:l,jobId:u,event:"lambda_invocation_started",metadata:{invocationId:f,functionName:d,operationGroup:n,coldStart:s,requestMetadata:y}});let S=Date.now();try{let g=await e(o,c),m=Date.now()-S;console.info("Lambda invocation completed",{invocationId:f,functionName:d,requestId:l,sessionId:a,jobId:u,durationMs:m,operationGroup:n,coldStart:s});let p=Be(o)?bn(g,{event:o,requestMetadata:y,durationMs:m}):null;if(p){let b=En({invocationId:f,functionName:d,requestId:l,sessionId:a,jobId:u,operationGroup:n,durationMs:m,method:p.method,path:p.path,pathCategory:p.pathCategory,statusCode:p.statusCode,contentLength:p.contentLength,sessionCount:p.sessionCount,downloadCount:p.downloadCount,assetRequest:p.isAssetRequest||void 0});console.info("API gateway response summary",b),p.isAssetRequest&&console.info("API gateway asset response",b),p.statusCode===404&&console.warn("API gateway not found response",b),(Number.isFinite(p.sessionCount)&&p.sessionCount>0||Number.isFinite(p.downloadCount)&&p.downloadCount>0)&&console.info("API gateway session download totals",{...b,sessionCount:p.sessionCount,downloadCount:p.downloadCount}),await H({sessionId:a,requestId:l,jobId:u,event:"lambda_http_response_summary",metadata:{...b,requestMetadata:y}})}return await H({sessionId:a,requestId:l,jobId:u,event:"lambda_invocation_succeeded",metadata:{invocationId:f,functionName:d,operationGroup:n,durationMs:m,coldStart:s}}),await Ve({functionName:d,durationMs:m,success:!0,coldStart:s,operationGroup:n,httpSummary:p}),s=!1,g}catch(g){let m=Date.now()-S;if(console.error("Lambda invocation failed",{invocationId:f,functionName:d,requestId:l,sessionId:a,jobId:u,durationMs:m,operationGroup:n,coldStart:s,errorMessage:g?.message,errorCode:g?.code}),await H({sessionId:a,requestId:l,jobId:u,event:"lambda_invocation_failed",metadata:{invocationId:f,functionName:d,operationGroup:n,durationMs:m,coldStart:s,errorMessage:g?.message,errorCode:g?.code}}),await Ve({functionName:d,durationMs:m,success:!1,coldStart:s,operationGroup:n,httpSummary:void 0}),(r||n&&["artifact-generation","artifact-download","enhancement"].includes(n))&&await Rn({error:g,requestId:l,sessionId:a,jobId:u,functionName:d,operationGroup:n,metadata:{invocationId:f,durationMs:m,requestMetadata:y},prefix:n==="artifact-generation"||n==="artifact-download"||n==="enhancement"?Zt:Xt}),s=!1,Be(o))return Cn(g,{requestId:l});throw g}}}var In=async(e={})=>{let t=typeof e.type=="string"?e.type:"improve-summary";return Ae({...e,type:t})},xn=$e(In,{name:"workflow-enhancement-section",operationGroup:"enhancement",captureErrorTrace:!0}),hr=xn;export{hr as default,xn as handler};
