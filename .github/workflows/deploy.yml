name: Deploy

on:
  push:
    branches:
      - main
      - v2
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip running the test suite before deployment"
        type: boolean
        default: false
      allow_cloudfront_failure:
        description: "Allow CloudFront verification to fail without failing the workflow"
        type: boolean
        default: false

concurrency:
  group: deploy-${{ github.ref || 'manual' }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to prod
    runs-on: ubuntu-latest
    environment:
      name: prod
    permissions:
      contents: read
    env:
      NODE_VERSION: '20'
      STAGE_NAME: prod
      DEPLOYMENT_ENVIRONMENT: prod
      ALLOW_CLOUDFRONT_VERIFY_FAILURE: "${{ github.event_name == 'workflow_dispatch' && github.event.inputs.allow_cloudfront_failure || 'false' }}"
      # Prevent uploader from auto-creating buckets; provision via IaC instead
      DISABLE_BUCKET_AUTOCREATE: 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Export deployment secrets
        env:
          SECRET_AWS_REGION: ${{ secrets.AWS_REGION }} # actionlint: allow
          SECRET_AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }} # actionlint: allow
          SECRET_AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # actionlint: allow
          SECRET_SAM_STACK_NAME: ${{ secrets.SAM_STACK_NAME }} # actionlint: allow
          SECRET_SAM_DEPLOY_ARGS: ${{ secrets.SAM_DEPLOY_ARGS || '' }} # actionlint: allow
          SECRET_CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} # actionlint: allow
          SECRET_GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # actionlint: allow
        run: |
          cat <<EOF >> "$GITHUB_ENV"
          AWS_REGION=${SECRET_AWS_REGION}
          AWS_ACCESS_KEY_ID=${SECRET_AWS_ACCESS_KEY_ID}
          AWS_SECRET_ACCESS_KEY=${SECRET_AWS_SECRET_ACCESS_KEY}
          SAM_STACK_NAME=${SECRET_SAM_STACK_NAME}
          SAM_DEPLOY_ARGS=${SECRET_SAM_DEPLOY_ARGS}
          CLOUDFRONT_DISTRIBUTION_ID=${SECRET_CLOUDFRONT_DISTRIBUTION_ID}
          GEMINI_API_KEY=${SECRET_GEMINI_API_KEY}
          EOF

      - name: Generate CloudFront metadata
        run: |
          set -euo pipefail
          npm run publish:cloudfront-url -- "$SAM_STACK_NAME"

      - name: Resolve deployment context
        run: |
          set -euo pipefail
          node scripts/export-static-deployment-context.mjs --format=github >> "$GITHUB_ENV"

      - name: Validate deployment configuration
        run: |
          set -euo pipefail
          if [ -z "${AWS_ACCESS_KEY_ID:-}" ] || [ -z "${AWS_SECRET_ACCESS_KEY:-}" ]; then
            echo 'AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY secrets are required for deployments.' >&2
            exit 1
          fi
          if [ -z "${AWS_REGION:-${AWS_DEFAULT_REGION:-}}" ]; then
            echo 'AWS region could not be resolved. Ensure config/published-cloudfront.json includes originRegion.' >&2
            exit 1
          fi
          if [ -z "${STATIC_ASSETS_BUCKET:-}" ]; then
            echo 'Unable to determine static asset bucket. Populate config/published-cloudfront.json or set STATIC_ASSETS_BUCKET.' >&2
            exit 1
          fi
          if [ -z "${STATIC_ASSETS_PREFIX:-}" ]; then
            echo 'Unable to determine static asset prefix. Update config/published-cloudfront.json with originPath.' >&2
            exit 1
          fi
          stack_name="${SAM_STACK_NAME:-${STACK_NAME:-}}"
          if [ -z "$stack_name" ]; then
            echo 'Unable to resolve the SAM stack name. Set the SAM_STACK_NAME secret or populate config/published-cloudfront.json with stackName.' >&2
            exit 1
          fi
          distribution_id="${CLOUDFRONT_DISTRIBUTION_ID:-}"
          if [ -z "$distribution_id" ]; then
            echo 'Unable to resolve CloudFront distribution id. Set the CLOUDFRONT_DISTRIBUTION_ID secret or ensure config/published-cloudfront.json includes distributionId.' >&2
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Run verification suite
        if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.skip_tests != 'true' }}
        run: npm run verify

      - name: Setup AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          version: '1.*'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION != '' && env.AWS_REGION || env.AWS_DEFAULT_REGION }} # actionlint: allow
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }} # actionlint: allow
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }} # actionlint: allow

      - name: Prepare deployment artifacts
        run: |
          set -euo pipefail
          export STAGE_NAME="${STAGE_NAME:-prod}"
          export DEPLOYMENT_ENVIRONMENT="${DEPLOYMENT_ENVIRONMENT:-prod}"
          npm run clean
          npm run predeploy:sam
          sam build --template-file template.yaml --cached --parallel
          
      - name: Debug build artifacts
        run: |
          echo "Listing build artifacts size:"
          du -h -d 2 .aws-sam/build/
          ls -R .aws-sam/build/

      - name: Upload static client assets
        run: |
          set -euo pipefail
          export STAGE_NAME="${STAGE_NAME:-prod}"
          export DEPLOYMENT_ENVIRONMENT="${DEPLOYMENT_ENVIRONMENT:-prod}"
          export DISABLE_BUCKET_AUTOCREATE="${DISABLE_BUCKET_AUTOCREATE:-true}"
          npm run upload:static

      - name: Upload hashed index bundles
        run: |
          set -euo pipefail
          export STAGE_NAME="${STAGE_NAME:-prod}"
          export DEPLOYMENT_ENVIRONMENT="${DEPLOYMENT_ENVIRONMENT:-prod}"
          export DISABLE_BUCKET_AUTOCREATE="${DISABLE_BUCKET_AUTOCREATE:-true}"
          npm run upload:hashed

      - name: Verify static asset upload
        run: |
          set -euo pipefail
          export STAGE_NAME="${STAGE_NAME:-prod}"
          export DEPLOYMENT_ENVIRONMENT="${DEPLOYMENT_ENVIRONMENT:-prod}"
          export DISABLE_BUCKET_AUTOCREATE="${DISABLE_BUCKET_AUTOCREATE:-true}"
          npm run verify:static -- --skip-cloudfront

      - name: Deploy SAM stack
        run: |
          set -euo pipefail
          export STAGE_NAME="${STAGE_NAME:-prod}"
          export DEPLOYMENT_ENVIRONMENT="${DEPLOYMENT_ENVIRONMENT:-prod}"
          extra_args=()
          if [ -n "${SAM_DEPLOY_ARGS:-}" ]; then
            # shellcheck disable=SC2206
            extra_args=(${SAM_DEPLOY_ARGS})
          fi
          # Ensure static assets bucket is provisioned by the stack with a stable name
          if [ -n "${STATIC_ASSETS_BUCKET:-}" ]; then
            extra_args+=(
              --parameter-overrides
              CreateStaticAssetsBucket=false
              StaticAssetsBucketName="${STATIC_ASSETS_BUCKET}"
              GeminiApiKey="${GEMINI_API_KEY}"
            )
          else
            # Fall back to template default which now creates the bucket with generated name
            extra_args+=(
              --parameter-overrides
              CreateStaticAssetsBucket=true
              GeminiApiKey="${GEMINI_API_KEY}"
            )
          fi
          sam deploy \
            --template-file .aws-sam/build/template.yaml \
            --stack-name "$SAM_STACK_NAME" \
            --s3-bucket "${STATIC_ASSETS_BUCKET}" \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            "${extra_args[@]}"

      - name: Resolve CloudFront domain
        id: resolve_domain
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          set -euo pipefail
          domain=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DISTRIBUTION_ID" \
            --query 'Distribution.DomainName' --output text)
          if [ -z "$domain" ]; then
            echo "Unable to resolve CloudFront domain for distribution $CLOUDFRONT_DISTRIBUTION_ID" >&2
            exit 1
          fi
          url="https://$domain"
          echo "Resolved CloudFront domain: $url"
          echo "url=$url" >> "$GITHUB_OUTPUT"

      - name: Invalidate CloudFront cache
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          set -euo pipefail
          aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
            --paths '/*'

      - name: Smoke test CDN assets
        if: steps.resolve_domain.outputs.url != ''
        env:
          CLOUDFRONT_URL: ${{ steps.resolve_domain.outputs.url }}
        run: |
          set -euo pipefail
          export STAGE_NAME="${STAGE_NAME:-prod}"
          export DEPLOYMENT_ENVIRONMENT="${DEPLOYMENT_ENVIRONMENT:-prod}"
          npm run verify:static

      - name: Verify CloudFront distribution
        if: steps.resolve_domain.outputs.url != ''
        env:
          ALLOW_CLOUDFRONT_VERIFY_FAILURE: ${{ env.ALLOW_CLOUDFRONT_VERIFY_FAILURE }}
        run: npm run verify:cloudfront -- ${{ steps.resolve_domain.outputs.url }}

      - name: Publish deployment summary
        if: always()
        run: |
          {
            echo "## ResumeForge deployment"
            echo
            echo "* Environment: ${STAGE_NAME:-prod}"
            echo "* Status: ${{ job.status }}"
            if [ "${{ steps.resolve_domain.outputs.url }}" != "" ]; then
              echo "* CloudFront domain: ${{ steps.resolve_domain.outputs.url }}"
            fi
            if [ "${CLOUDFRONT_DISTRIBUTION_ID}" != "" ]; then
              echo "* CloudFront invalidation: Triggered for distribution ${CLOUDFRONT_DISTRIBUTION_ID} (/*)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"


