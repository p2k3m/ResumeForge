name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment to deploy"
        type: choice
        default: staging
        options:
          - dev
          - staging
          - prod
      skip_tests:
        description: "Skip running the test suite before deployment"
        type: boolean
        default: false
      allow_cloudfront_failure:
        description: "Allow CloudFront verification to fail without failing the workflow"
        type: boolean
        default: false

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'staging' }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    permissions:
      contents: read
      id-token: write
    env:
      NODE_VERSION: '20'
      AWS_REGION: ${{ secrets.AWS_REGION }}
      SAM_STACK_NAME: ${{ secrets.SAM_STACK_NAME }}
      SAM_DEPLOY_ARGS: ${{ secrets.SAM_DEPLOY_ARGS }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      TARGET_ENVIRONMENT: ${{ github.event.inputs.environment || 'staging' }}
      ALLOW_CLOUDFRONT_VERIFY_FAILURE: ${{ github.event.inputs.allow_cloudfront_failure }}
    steps:
      - name: Validate deployment secrets
        run: |
          set -euo pipefail
          if [ -z "${AWS_REGION:-}" ]; then
            echo "AWS_REGION secret is required" >&2
            exit 1
          fi
          if [ -z "${SAM_STACK_NAME:-}" ]; then
            echo "SAM_STACK_NAME secret is required" >&2
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run verification suite
        if: github.event.inputs.skip_tests != 'true'
        run: npm run verify

      - name: Setup AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          version: '1.*'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: ResumeForgeDeploy

      - name: Prepare deployment artifacts
        env:
          STAGE_NAME: ${{ env.TARGET_ENVIRONMENT }}
        run: |
          set -euo pipefail
          npm run predeploy:sam
          sam build --template-file template.yaml --cached --parallel

      - name: Deploy SAM stack
        env:
          STAGE_NAME: ${{ env.TARGET_ENVIRONMENT }}
        run: |
          set -euo pipefail
          extra_args=()
          if [ -n "${SAM_DEPLOY_ARGS:-}" ]; then
            # shellcheck disable=SC2206
            extra_args=(${SAM_DEPLOY_ARGS})
          fi
          sam deploy \
            --template-file template.yaml \
            --stack-name "$SAM_STACK_NAME" \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
            "${extra_args[@]}"

      - name: Resolve CloudFront domain
        id: resolve_domain
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          set -euo pipefail
          domain=$(aws cloudfront get-distribution --id "$CLOUDFRONT_DISTRIBUTION_ID" \
            --query 'Distribution.DomainName' --output text)
          if [ -z "$domain" ]; then
            echo "Unable to resolve CloudFront domain for distribution $CLOUDFRONT_DISTRIBUTION_ID" >&2
            exit 1
          fi
          url="https://$domain"
          echo "Resolved CloudFront domain: $url"
          echo "url=$url" >> "$GITHUB_OUTPUT"

      - name: Invalidate CloudFront cache
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          set -euo pipefail
          aws cloudfront create-invalidation \
            --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
            --paths '/*'

      - name: Verify CloudFront distribution
        if: steps.resolve_domain.outputs.url != ''
        env:
          ALLOW_CLOUDFRONT_VERIFY_FAILURE: ${{ env.ALLOW_CLOUDFRONT_VERIFY_FAILURE }}
        run: npm run verify:cloudfront -- ${{ steps.resolve_domain.outputs.url }}

      - name: Publish deployment summary
        if: always()
        run: |
          {
            echo "## ResumeForge deployment"
            echo
            echo "* Environment: ${{ env.TARGET_ENVIRONMENT }}"
            echo "* Status: ${{ job.status }}"
            if [ "${{ steps.resolve_domain.outputs.url }}" != "" ]; then
              echo "* CloudFront domain: ${{ steps.resolve_domain.outputs.url }}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"


