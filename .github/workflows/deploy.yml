name: CI and Deploy

on:
  push:
    branches:
      - v2
  pull_request:
    branches:
      - v2
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    name: Install and test
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '18'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install server dependencies
        run: npm ci

      - name: Run server tests
        run: npm test -- --runInBand

      - name: Install client dependencies
        run: npm ci
        working-directory: client

      - name: Build client bundle
        run: npm run build
        working-directory: client

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    env:
      NODE_VERSION: '18'
      STAGE_NAME: ${{ secrets.RESUMEFORGE_STAGE_NAME || 'prod' }}
      STACK_NAME: ${{ secrets.RESUMEFORGE_STACK_NAME }}
      DATA_BUCKET: ${{ secrets.RESUMEFORGE_DATA_BUCKET }}
      TABLE_NAME: ${{ secrets.RESUMEFORGE_TABLE_NAME || 'ResumeForge' }}
      SECRET_NAME: ${{ secrets.RESUMEFORGE_SECRET_NAME || 'ResumeForge' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required deployment secrets
        shell: bash
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          STACK_NAME: ${{ secrets.RESUMEFORGE_STACK_NAME }}
          DATA_BUCKET: ${{ secrets.RESUMEFORGE_DATA_BUCKET }}
          SECRET_NAME: ${{ secrets.RESUMEFORGE_SECRET_NAME }}
        run: |
          missing=()
          for name in AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_REGION STACK_NAME DATA_BUCKET SECRET_NAME; do
            if [ -z "${!name}" ]; then
              missing+=("$name")
            fi
          done
          if [ "${#missing[@]}" -ne 0 ]; then
            printf '::error::Missing required secrets: %s\n' "${missing[*]}"
            exit 1
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install server dependencies
        run: npm ci

      - name: Install client dependencies
        run: npm ci
        working-directory: client

      - name: Set up AWS SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Build serverless application
        run: sam build

      - name: Deploy stack
        shell: bash
        run: |
          set -euo pipefail

          tmp_err=$(mktemp)
          trap 'rm -f "$tmp_err"' EXIT

          if stack_status=$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query "Stacks[0].StackStatus" \
              --output text 2>"$tmp_err"); then
            echo "Found existing stack '$STACK_NAME' with status: $stack_status"
            if [ "$stack_status" = "ROLLBACK_COMPLETE" ]; then
              echo "Stack in ROLLBACK_COMPLETE state. Deleting before redeploy."
              aws cloudformation delete-stack --stack-name "$STACK_NAME"
              aws cloudformation wait stack-delete-complete --stack-name "$STACK_NAME"
              echo "Stack deletion complete. Proceeding with deployment."
            fi
          else
            describe_err=$(cat "$tmp_err")
            if echo "$describe_err" | grep -qi "does not exist"; then
              echo "Stack '$STACK_NAME' does not exist. Proceeding with deployment."
            else
              echo "$describe_err" >&2
              exit 1
            fi
          fi

          sam deploy \
            --stack-name "$STACK_NAME" \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              StageName="$STAGE_NAME" \
              DataBucketName="$DATA_BUCKET" \
              ResumeTableName="$TABLE_NAME" \
              SecretName="$SECRET_NAME"
