name: Automated pipeline repair

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  autofix:
    if: >-
      ${{ github.event.workflow_run.conclusion == 'failure' &&
          (github.event.workflow_run.event == 'pull_request' ||
           github.event.workflow_run.head_branch == 'main' ||
           github.event.workflow_run.head_branch == 'v2') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci --omit=dev

      - name: Resolve base branch
        env:
          WORKFLOW_RUN_PAYLOAD: ${{ toJson(github.event.workflow_run) }}
        run: |
          set -euo pipefail
          node <<'EOF'
          const fs = require('fs')
          let base = ''
          try {
            const payload = JSON.parse(process.env.WORKFLOW_RUN_PAYLOAD || '{}')
            if (payload && typeof payload === 'object') {
              if (typeof payload.head_branch === 'string' && payload.head_branch.trim()) {
                base = payload.head_branch.trim()
              }
              if (
                payload.event === 'pull_request' &&
                Array.isArray(payload.pull_requests) &&
                payload.pull_requests.length > 0
              ) {
                const pr = payload.pull_requests[0]
                if (pr && pr.base && typeof pr.base.ref === 'string' && pr.base.ref.trim()) {
                  base = pr.base.ref.trim()
                }
              }
            }
          } catch (error) {
            // Fallback to default branch when payload parsing fails.
          }

          if (!base) {
            base = 'main'
          }

          fs.appendFileSync(process.env.GITHUB_ENV, `AUTOFIX_BASE_BRANCH=${base}\n`)
          EOF

      - name: Run automated pipeline repair
        env:
          GITHUB_TOKEN: ${{ github.token }}
          OPENAI_API_KEY: ${{ secrets.GEMINI_API_KEY }} # actionlint: allow
          REPO_OWNER: ${{ github.event.workflow_run.repository.owner.login }}
          REPO_NAME: ${{ github.event.workflow_run.repository.name }}
          AUTOFIX_TARGET_RUN_ID: ${{ github.event.workflow_run.id }}
        run: |
          set -euo pipefail
          npm run autofix:pipeline
