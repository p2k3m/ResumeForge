<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="resumeforge-api-base" content="" />
    <title>ResumeForge</title>
    <style>
      :root {
        color-scheme: light dark;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f8fafc;
      }
      #cloudfront-degraded-banner {
        box-sizing: border-box;
        width: min(720px, calc(100% - 2.5rem));
        margin: 2rem auto 0;
        padding: 1.5rem;
        border-radius: 16px;
        border: 1px solid rgba(234, 179, 8, 0.4);
        background: linear-gradient(180deg, rgba(253, 224, 71, 0.3) 0%, rgba(254, 249, 195, 0.45) 100%);
        color: #78350f;
        box-shadow: 0 20px 50px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }
      #cloudfront-degraded-banner[hidden] {
        display: none !important;
      }
      #cloudfront-degraded-banner .cloudfront-degraded__title {
        margin: 0;
        font-size: clamp(1.25rem, 3vw, 1.65rem);
        font-weight: 700;
        color: #92400e;
      }
      #cloudfront-degraded-banner .cloudfront-degraded__body {
        margin: 0;
        font-size: 0.95rem;
        line-height: 1.55;
      }
      #cloudfront-degraded-banner a {
        color: #b45309;
        font-weight: 600;
        text-decoration: none;
        word-break: break-all;
      }
      #cloudfront-degraded-banner a:hover,
      #cloudfront-degraded-banner a:focus {
        text-decoration: underline;
      }
      #cloudfront-degraded-banner code {
        font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          'Liberation Mono', 'Courier New', monospace;
        background: rgba(254, 240, 138, 0.6);
        padding: 0.2rem 0.45rem;
        border-radius: 6px;
        font-size: 0.9rem;
      }
      #static-asset-warning {
        box-sizing: border-box;
        width: min(720px, calc(100% - 2.5rem));
        margin: 3.5rem auto;
        padding: 1.75rem;
        border-radius: 16px;
        border: 1px solid rgba(220, 38, 38, 0.25);
        background: linear-gradient(180deg, #fff5f5 0%, #fffef9 100%);
        color: #7f1d1d;
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }
      #static-asset-warning[hidden] {
        display: none !important;
      }
      #static-asset-warning .static-asset-warning__title {
        margin: 0;
        font-size: clamp(1.35rem, 3vw, 1.75rem);
        font-weight: 700;
      }
      #static-asset-warning .static-asset-warning__body {
        margin: 0;
        font-size: 1rem;
        line-height: 1.6;
      }
      #static-asset-warning code {
        font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          'Liberation Mono', 'Courier New', monospace;
        background: rgba(255, 255, 255, 0.65);
        padding: 0.2rem 0.45rem;
        border-radius: 6px;
        font-size: 0.95rem;
      }
      @media (prefers-color-scheme: dark) {
        body {
          background: #0f172a;
        }
        #cloudfront-degraded-banner {
          border-color: rgba(234, 179, 8, 0.55);
          background: linear-gradient(180deg, rgba(180, 83, 9, 0.4) 0%, rgba(120, 53, 15, 0.3) 100%);
          color: #fef3c7;
          box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45);
        }
        #cloudfront-degraded-banner code {
          background: rgba(120, 53, 15, 0.5);
          color: #fef3c7;
        }
        #cloudfront-degraded-banner a {
          color: #fbbf24;
        }
        #static-asset-warning {
          border-color: rgba(248, 113, 113, 0.4);
          background: linear-gradient(180deg, rgba(248, 113, 113, 0.2) 0%, rgba(248, 113, 113, 0.1) 100%);
          color: #fee2e2;
          box-shadow: 0 24px 60px rgba(0, 0, 0, 0.45);
        }
        #static-asset-warning code {
          background: rgba(15, 23, 42, 0.4);
          color: #fef2f2;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <section
      id="cloudfront-degraded-banner"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
      hidden
      data-visible="false"
    >
      <h1 class="cloudfront-degraded__title">CloudFront is unavailable â€” using API Gateway fallback</h1>
      <p class="cloudfront-degraded__body">
        ResumeForge routed you directly to the API Gateway so you can continue working while the CDN recovers.
      </p>
      <p class="cloudfront-degraded__body" data-cloudfront-domain-wrapper hidden>
        Primary CloudFront domain: <code data-cloudfront-domain></code>
      </p>
      <p class="cloudfront-degraded__body" data-backup-api-wrapper hidden>
        Backup endpoint:
        <a data-backup-api-link href="#" rel="noopener noreferrer" target="_blank">
          <span data-backup-api-text></span>
        </a>
      </p>
      <p class="cloudfront-degraded__body" data-cloudfront-updated-wrapper hidden>
        Metadata last updated at <time data-cloudfront-updated></time>
      </p>
      <input type="hidden" name="resumeforge-backup-api-base" data-backup-api-base value="" />
    </section>
    <div
      id="static-asset-warning"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
      hidden
      data-visible="false"
    >
      <h1 class="static-asset-warning__title">We're having trouble loading ResumeForge</h1>
      <p class="static-asset-warning__body">
        The static assets required to run the portal could not be downloaded. This often happens when the
        CDN is temporarily unavailable or a cached bundle was removed before the page refreshed.
      </p>
      <p class="static-asset-warning__body">
        Please refresh the page in a few minutes. If the issue persists, contact support so we can restore
        access.
      </p>
      <p class="static-asset-warning__body" data-static-asset-source-wrapper hidden>
        Missing file: <code data-static-asset-source></code>
      </p>
    </div>
    <script>
      ;(function () {
        const setBackupInputValue = (value) => {
          const inputs = document.querySelectorAll('input[data-backup-api-base]')
          const nextValue = typeof value === 'string' ? value : ''
          inputs.forEach((input) => {
            if (input && typeof input.setAttribute === 'function') {
              input.value = nextValue
              input.setAttribute('value', nextValue)
            }
          })
        }

        const degradeBanner = document.getElementById('cloudfront-degraded-banner')
        const degradeDomainWrapper = degradeBanner?.querySelector('[data-cloudfront-domain-wrapper]')
        const degradeDomainLabel = degradeBanner?.querySelector('[data-cloudfront-domain]')
        const degradeBackupWrapper = degradeBanner?.querySelector('[data-backup-api-wrapper]')
        const degradeBackupLink = degradeBanner?.querySelector('[data-backup-api-link]')
        const degradeBackupText = degradeBanner?.querySelector('[data-backup-api-text]')
        const degradeUpdatedWrapper = degradeBanner?.querySelector('[data-cloudfront-updated-wrapper]')
        const degradeUpdated = degradeBanner?.querySelector('[data-cloudfront-updated]')

        const revealDegradeBanner = ({ canonicalHost, backupUrl, updatedAt }) => {
          if (!degradeBanner) {
            return
          }

          if (canonicalHost && degradeDomainWrapper && degradeDomainLabel) {
            degradeDomainLabel.textContent = canonicalHost
            degradeDomainWrapper.hidden = false
          }

          if (backupUrl && degradeBackupWrapper && degradeBackupLink && degradeBackupText) {
            degradeBackupLink.href = backupUrl
            degradeBackupText.textContent = backupUrl
            degradeBackupWrapper.hidden = false
          }

          if (updatedAt && degradeUpdated && degradeUpdatedWrapper) {
            degradeUpdated.textContent = updatedAt
            degradeUpdatedWrapper.hidden = false
          }

          const wasVisible = degradeBanner.dataset.visible === 'true'
          if (!wasVisible) {
            degradeBanner.dataset.visible = 'true'
            degradeBanner.hidden = false
          }
        }

        const applyDegradedState = ({ canonicalUrl, backupUrl, updatedAt }) => {
          let canonicalHost = ''
          if (canonicalUrl) {
            try {
              canonicalHost = new URL(canonicalUrl, window.location.href).hostname
            } catch (error) {
              console.warn('Unable to parse CloudFront metadata URL.', error)
            }
          }

          const sanitizedBackup = backupUrl || ''

          if (sanitizedBackup) {
            setBackupInputValue(sanitizedBackup)
          }

          if (degradeBanner) {
            revealDegradeBanner({ canonicalHost, backupUrl: sanitizedBackup, updatedAt })
          }

          try {
            window.__RESUMEFORGE_CLOUDFRONT_DEGRADE__ = {
              canonicalUrl: canonicalUrl || '',
              backupApiGatewayUrl: sanitizedBackup,
              detectedAt: updatedAt || new Date().toISOString()
            }
          } catch (error) {
            console.warn('Unable to record CloudFront fallback metadata on the window.', error)
          }
        }

        if (degradeBanner) {
          const host = typeof window.location?.hostname === 'string' ? window.location.hostname : ''
          const onApiGateway = /\.execute-api\.[^.]+\.amazonaws\.com$/i.test(host)

          if (onApiGateway) {
            const fallbackOrigin = typeof window.location?.origin === 'string' ? window.location.origin : ''

            const handleMetadata = (payload) => {
              const canonicalUrl =
                typeof payload?.cloudfront?.url === 'string' && payload.cloudfront.url.trim()
                  ? payload.cloudfront.url.trim()
                  : ''
              const backupUrl =
                typeof payload?.cloudfront?.apiGatewayUrl === 'string' && payload.cloudfront.apiGatewayUrl.trim()
                  ? payload.cloudfront.apiGatewayUrl.trim()
                  : fallbackOrigin
              const updatedAt =
                typeof payload?.cloudfront?.updatedAt === 'string' && payload.cloudfront.updatedAt.trim()
                  ? payload.cloudfront.updatedAt.trim()
                  : ''

              applyDegradedState({ canonicalUrl, backupUrl, updatedAt })
            }

            if (typeof fetch === 'function') {
              fetch('/api/published-cloudfront', { method: 'GET' })
                .then((response) => (response && response.ok ? response.json() : null))
                .then((data) => handleMetadata(data))
                .catch((error) => {
                  console.warn('Unable to load published CloudFront metadata.', error)
                  handleMetadata(null)
                })
            } else {
              handleMetadata(null)
            }
          } else {
            setBackupInputValue('')
          }
        }

        const HARD_REFRESH_PARAM = '__rf_refresh'
        const HARD_REFRESH_STORAGE_KEY = '__resumeforge_last_hard_refresh'
        const HARD_REFRESH_MIN_INTERVAL_MS = 5 * 60 * 1000

        try {
          const currentUrl = new URL(window.location.href)
          if (currentUrl.searchParams.has(HARD_REFRESH_PARAM)) {
            currentUrl.searchParams.delete(HARD_REFRESH_PARAM)
            if (typeof window.history?.replaceState === 'function') {
              window.history.replaceState(
                null,
                document.title,
                `${currentUrl.pathname}${currentUrl.search}${currentUrl.hash}`
              )
            }
          }
        } catch (error) {
          // Ignore URL parsing errors in constrained environments.
        }

        const warning = document.getElementById('static-asset-warning')
        if (!warning) {
          return
        }

        const sourceWrapper = warning.querySelector('[data-static-asset-source-wrapper]')
        const sourceLabel = warning.querySelector('[data-static-asset-source]')

        const appendCacheBustParam = (source) => {
          if (!source) {
            return ''
          }

          try {
            const parsed = new URL(source, window.location.href)
            parsed.searchParams.set('__rf_retry', Date.now().toString(36))
            return parsed.href
          } catch (error) {
            const separator = source.includes('?') ? '&' : '?'
            return `${source}${separator}__rf_retry=${Date.now().toString(36)}`
          }
        }

        const attemptCacheBustingReload = (element) => {
          if (!element || typeof element.tagName !== 'string') {
            return false
          }

          if (element.dataset?.resumeforgeAssetRetry === 'true') {
            return false
          }

          const tagName = element.tagName.toLowerCase()
          const isStylesheet =
            tagName === 'link' && typeof element.rel === 'string' && element.rel.toLowerCase() === 'stylesheet'
          const isScript = tagName === 'script'

          if (!isScript && !isStylesheet) {
            return false
          }

          const originalSource = describeSource(element)
          if (!originalSource) {
            return false
          }

          const retrySource = appendCacheBustParam(originalSource)
          if (!retrySource) {
            return false
          }

          const parent = element.parentNode
          if (!parent || typeof parent.replaceChild !== 'function') {
            return false
          }

          const replacement = element.cloneNode(true)

          if (isStylesheet) {
            replacement.href = retrySource
          } else {
            replacement.src = retrySource
          }

          replacement.setAttribute('data-src', retrySource)
          replacement.dataset.resumeforgeAssetRetry = 'true'
          replacement.dataset.resumeforgeOriginalSource = originalSource

          element.dataset.resumeforgeAssetRetry = 'true'
          element.dataset.resumeforgeOriginalSource = originalSource

          try {
            parent.replaceChild(replacement, element)
          } catch (error) {
            try {
              parent.removeChild(element)
              parent.appendChild(replacement)
            } catch (innerError) {
              return false
            }
          }

          try {
            console.warn('Retrying ResumeForge static asset with cache bust parameter.', {
              source: originalSource,
              retry: retrySource
            })
          } catch (error) {
            // Ignore logging errors in constrained environments.
          }

          return true
        }

        const logFailure = (sourceText) => {
          if (sourceText) {
            console.error('ResumeForge static asset failed to load.', { source: sourceText })
          } else {
            console.error('ResumeForge static asset failed to load.')
          }
        }

        const recordHardRefreshAttempt = () => {
          try {
            const storage = window.sessionStorage || window.localStorage
            if (!storage) {
              return
            }

            storage.setItem(
              HARD_REFRESH_STORAGE_KEY,
              Date.now().toString()
            )
          } catch (error) {
            // Ignore storage errors (private mode, etc.)
          }
        }

        const shouldAttemptHardRefresh = () => {
          try {
            const storage = window.sessionStorage || window.localStorage
            if (!storage) {
              return true
            }

            const rawTimestamp = storage.getItem(HARD_REFRESH_STORAGE_KEY)
            if (!rawTimestamp) {
              return true
            }

            const parsed = Number.parseInt(rawTimestamp, 10)
            if (!Number.isFinite(parsed)) {
              return true
            }

            return Date.now() - parsed >= HARD_REFRESH_MIN_INTERVAL_MS
          } catch (error) {
            return true
          }
        }

        const attemptHardRefresh = () => {
          if (!shouldAttemptHardRefresh()) {
            return false
          }

          try {
            const current = new URL(window.location.href)
            if (!current.searchParams.has(HARD_REFRESH_PARAM)) {
              current.searchParams.set(
                HARD_REFRESH_PARAM,
                Date.now().toString(36)
              )
            } else {
              current.searchParams.set(
                HARD_REFRESH_PARAM,
                Date.now().toString(36)
              )
            }

            recordHardRefreshAttempt()
            window.location.replace(current.href)
            return true
          } catch (error) {
            try {
              recordHardRefreshAttempt()
              window.location.reload()
              return true
            } catch (innerError) {
              return false
            }
          }
        }

        const revealWarning = (sourceText) => {
          if (sourceText && sourceLabel && sourceWrapper) {
            sourceLabel.textContent = sourceText
            sourceWrapper.hidden = false
          }

          const wasVisible = warning.dataset.visible === 'true'
          if (!wasVisible) {
            warning.dataset.visible = 'true'
            warning.hidden = false
          }
          return wasVisible
        }

        const describeSource = (element) => {
          if (!element) {
            return ''
          }

          const originalDatasetSource =
            typeof element.dataset?.resumeforgeOriginalSource === 'string'
              ? element.dataset.resumeforgeOriginalSource
              : ''

          const rawSource =
            originalDatasetSource ||
            (typeof element.getAttribute === 'function' && element.getAttribute('data-src')) ||
            element.src ||
            element.href ||
            ''

          if (!rawSource) {
            return ''
          }

          try {
            const resolved = new URL(rawSource, window.location.href)
            if (resolved.origin === window.location.origin) {
              return `${resolved.pathname}${resolved.search}`
            }
            return resolved.href
          } catch (error) {
            return rawSource
          }
        }

        window.addEventListener(
          'error',
          (event) => {
            if (!event || !event.target) {
              return
            }

            const target = event.target
            const tagName = typeof target.tagName === 'string' ? target.tagName.toLowerCase() : ''
            const isStylesheet = tagName === 'link' && typeof target.rel === 'string' && target.rel.toLowerCase() === 'stylesheet'
            const isScript = tagName === 'script'

            if (!isScript && !isStylesheet) {
              return
            }

            if (attemptCacheBustingReload(target)) {
              return
            }

            const sourceText = describeSource(target)

            if (attemptHardRefresh()) {
              return
            }

            revealWarning(sourceText)
            logFailure(sourceText)
          },
          true
        )

        window.addEventListener('unhandledrejection', (event) => {
          if (!event || !event.reason) {
            return
          }

          const reason = event.reason
          const message =
            typeof reason === 'string'
              ? reason
              : typeof reason.message === 'string'
                ? reason.message
                : typeof reason.error === 'string'
                  ? reason.error
                  : ''

          if (!message) {
            return
          }

          if (/loading chunk|importing module|Failed to fetch dynamically imported module|module script/i.test(message)) {
            revealWarning('')
            logFailure('')
          }
        })
      })()
    </script>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
