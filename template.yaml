AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Serverless deployment for ResumeForge on AWS Lambda and API Gateway.

Parameters:
  StageName:
    Type: String
    Default: prod
    Description: Stage name for the API Gateway deployment.
  SecondaryRegion:
    Type: String
    Default: us-west-2
    Description: Secondary AWS region used for disaster recovery or failover.
  OriginRequestPolicyId:
    Type: String
    Default: b689b0a8-53d0-40ab-baf2-68738e2966ac
    Description: >-
      Identifier for the CloudFront origin request policy to use. Defaults to the
      AWS managed policy "Managed-AllViewerExceptHostHeader" which forwards all
      viewer headers except the Host header generated by CloudFront.
  WebAclArn:
    Type: String
    Default: ''
    Description: Optional ARN of an AWS WAFv2 web ACL to associate with the CloudFront distribution.
  DataBucketName:
    Type: String
    Default: resume-forge-data
    Description: Globally unique name for the S3 bucket that stores uploads and generated artifacts.
  CreateDataBucket:
    Type: String
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Description: >-
      Set to 'false' to use an existing S3 bucket specified in DataBucketName
      instead of creating a new one.
  ResumeTableName:
    Type: String
    Default: ResumeForge
    Description: Name of the DynamoDB table that tracks processed resumes.
  GeminiApiKey:
    Type: String
    NoEcho: true
    Default: ''
    Description: >-
      Gemini API key used by the Lambda function to generate enhanced resume
      content. Provide the value securely when deploying the stack or supply a
      Secrets Manager secret name instead.
  SecretName:
    Type: String
    Default: ''
    Description: >-
      Optional AWS Secrets Manager secret (JSON) that contains a
      GEMINI_API_KEY value. When provided, the Lambda environment resolves the
      API key from the secret at runtime. Leave blank to pass GeminiApiKey
      directly.
  ProvisionedConcurrency:
    Type: Number
    Default: 0
    MinValue: 0
    Description: >-
      Number of provisioned concurrent executions reserved for the Lambda alias.
      Set to 0 to disable provisioned concurrency.
  CreateResumeTable:
    Type: String
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Description: >-
      Set to 'false' to use an existing DynamoDB table specified in ResumeTableName
      instead of creating a new one.

Conditions:
  CreateResumeTableCondition: !Equals [!Ref CreateResumeTable, 'true']
  CreateDataBucketCondition: !Equals [!Ref CreateDataBucket, 'true']
  EnableProvisionedConcurrency: !Not [!Equals [!Ref ProvisionedConcurrency, 0]]
  AttachWebAcl: !Not [!Equals [!Ref WebAclArn, '']]
  UseSecretName: !Not [!Equals [!Ref SecretName, '']]
  SecretIsArn: !And
    - !Condition UseSecretName
    - !Equals [!Select [0, !Split [":", !Ref SecretName]], 'arn']

Rules:
  RequireGeminiConfiguration:
    Assertions:
      - Assert: !Or
          - !Not [!Equals [!Ref SecretName, '']]
          - !Not [!Equals [!Ref GeminiApiKey, '']]
        AssertDescription: >-
          Provide either SecretName (pointing to a Secrets Manager secret with
          GEMINI_API_KEY) or GeminiApiKey so the Lambda function can access the
          Gemini API.

Resources:
  ResumeForgeApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref StageName
      EndpointConfiguration: REGIONAL
      BinaryMediaTypes:
        - multipart/form-data
        - application/pdf
        - application/octet-stream
      Cors:
        AllowMethods: "'OPTIONS,POST'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"

  DataBucket:
    Type: AWS::S3::Bucket
    Condition: CreateDataBucketCondition
    Properties:
      BucketName: !Ref DataBucketName
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain

  DataBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !If [CreateDataBucketCondition, !Ref DataBucket, !Ref DataBucketName]
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowLambdaBucketActions
            Effect: Allow
            Principal:
              AWS: !GetAtt ResumeForgeFunctionRole.Arn
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
            Resource:
              - !If
                - CreateDataBucketCondition
                - !Sub arn:aws:s3:::${DataBucket}/*
                - !Sub arn:aws:s3:::${DataBucketName}/*
          - Sid: AllowLambdaListBucket
            Effect: Allow
            Principal:
              AWS: !GetAtt ResumeForgeFunctionRole.Arn
            Action:
              - s3:ListBucket
            Resource: !If
              - CreateDataBucketCondition
              - !Sub arn:aws:s3:::${DataBucket}
              - !Sub arn:aws:s3:::${DataBucketName}

  ResumeForgeTable:
    Type: AWS::DynamoDB::Table
    Condition: CreateResumeTableCondition
    Properties:
      TableName: !Ref ResumeTableName
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: linkedinProfileUrl
          AttributeType: S
      KeySchema:
        - AttributeName: linkedinProfileUrl
          KeyType: HASH

  ResumeForgeFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: ResumeForgeHandler
      CodeUri: .
      Handler: lambda.handler
      Runtime: nodejs18.x
      MemorySize: 2048
      Timeout: 300
      AutoPublishAlias: !Ref StageName
      ProvisionedConcurrencyConfig: !If
        - EnableProvisionedConcurrency
        -
          ProvisionedConcurrentExecutions: !Ref ProvisionedConcurrency
        - !Ref AWS::NoValue
      Events:
        ApiProxy:
          Type: Api
          Properties:
            RestApiId: !Ref ResumeForgeApi
            Path: /{proxy+}
            Method: ANY
        ApiRoot:
          Type: Api
          Properties:
            RestApiId: !Ref ResumeForgeApi
            Path: /
            Method: ANY
      Environment:
        Variables:
          S3_BUCKET: !Ref DataBucketName
          RESUME_TABLE_NAME: !Ref ResumeTableName
          GEMINI_API_KEY: !If
            - UseSecretName
            - !Sub '{{resolve:secretsmanager:${SecretName}:SecretString:GEMINI_API_KEY}}'
            - !Ref GeminiApiKey
          PRIMARY_REGION: !Ref AWS::Region
          SECONDARY_REGION: !Ref SecondaryRegion
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Sid: AllowBucketAccess
              Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:DeleteObject
                - s3:ListBucket
              Resource:
                - !Sub arn:aws:s3:::${DataBucketName}
                - !Sub arn:aws:s3:::${DataBucketName}/*
            - Sid: AllowWafIntegration
              Effect: Allow
              Action:
                - wafv2:AssociateWebACL
                - wafv2:DisassociateWebACL
                - wafv2:GetWebACL
              Resource: '*'
        - DynamoDBCrudPolicy:
            TableName: !Ref ResumeTableName
        - !If
          - UseSecretName
          - Statement:
              - Sid: AllowSecretAccess
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !If
                  - SecretIsArn
                  - !Ref SecretName
                  - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${SecretName}*
          - !Ref AWS::NoValue
      Layers: []
    Metadata:
      BuildMethod: makefile

  ResumeForgeCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Comment: Disable caching; viewer context is forwarded via a dedicated origin request policy.
        DefaultTTL: 0
        MaxTTL: 0
        MinTTL: 0
        Name: !Sub ResumeForgeCachePolicy-${AWS::StackName}
        ParametersInCacheKeyAndForwardedToOrigin:
          CookiesConfig:
            CookieBehavior: none
          EnableAcceptEncodingBrotli: false
          EnableAcceptEncodingGzip: false
          HeadersConfig:
            HeaderBehavior: none
          QueryStringsConfig:
            QueryStringBehavior: none

  ResumeForgeDistribution:
    Type: AWS::CloudFront::Distribution
    DependsOn:
      - ResumeForgeApi
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: API Gateway distribution for ResumeForge
        WebACLId: !If [AttachWebAcl, !Ref WebAclArn, !Ref AWS::NoValue]
        Origins:
          - Id: ResumeForgeApiOrigin
            DomainName: !Sub "${ResumeForgeApi}.execute-api.${AWS::Region}.amazonaws.com"
            OriginPath: !Sub "/${StageName}"
            CustomOriginConfig:
              OriginProtocolPolicy: https-only
        DefaultCacheBehavior:
          TargetOriginId: ResumeForgeApiOrigin
          ViewerProtocolPolicy: https-only
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - PATCH
            - POST
            - DELETE
          CachedMethods:
            - GET
            - HEAD
            - OPTIONS
          Compress: true
          CachePolicyId: !GetAtt ResumeForgeCachePolicy.Id
          OriginRequestPolicyId: !Ref OriginRequestPolicyId

Outputs:
  ApiBaseUrl:
    Description: Invoke URL for the API Gateway stage.
    Value: !Sub https://${ResumeForgeApi}.execute-api.${AWS::Region}.amazonaws.com/${StageName}
  AppBaseUrl:
    Description: Primary CloudFront URL for the ResumeForge front page and API access.
    Value: !Sub https://${ResumeForgeDistribution.DomainName}
  DataBucket:
    Description: Bucket used for uploads and generated files.
    Value: !If [CreateDataBucketCondition, !Ref DataBucket, !Ref DataBucketName]
  ResumeTable:
    Description: DynamoDB table that stores resume processing metadata.
    Value: !If [CreateResumeTableCondition, !Ref ResumeForgeTable, !Ref ResumeTableName]
  CloudFrontUrl:
    Description: CloudFront distribution domain for accessing the API.
    Value: !Sub https://${ResumeForgeDistribution.DomainName}
  PrimaryRegion:
    Description: Primary AWS region configured for the deployment.
    Value: !Ref AWS::Region
  SecondaryRegion:
    Description: Secondary AWS region configured for the deployment.
    Value: !Ref SecondaryRegion
